<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ù„ÙˆØ­Ø© Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© â€” Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© / Ø§Ù„Ø·Ù„Ø§Ø¨ / Ø§Ù„Ø¥ÙŠØµØ§Ù„Ø§Øª</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --brand:#17974b;--ink:#0b1324;--muted:#475569;--line:#e9eef5;--card:#fff;--bg:#f7f9fb;
    /* Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© */
    --ui-zoom:1;          /* 1 = 100% ØŒ 0.75 = 75% */
    --icon-zoom:1;        /* 1 Ø¹Ø§Ø¯ÙŠØŒ 0.9 ØµØºÙŠØ±ØŒ 1.1 ÙƒØ¨ÙŠØ± */
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:#000;font-family:'Cairo',system-ui,Segoe UI,Roboto,Arial}
  body{visibility:hidden; transform-origin: top center; }
  body.ready{visibility:visible}
  /* Ø§Ù„ØªÙƒØ¨ÙŠØ±/Ø§Ù„ØªØµØºÙŠØ± Ø§Ù„Ø¹Ø§Ù… Ù„Ù„ÙˆØ§Ø¬Ù‡Ø© */
  body{ transform: scale(var(--ui-zoom)); }
  /* Ù„Ù…Ù†Ø¹ ØªØµØºÙŠØ± Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙØ¹Ù„ÙŠ Ø¹Ù†Ø¯ Ø§Ù„ØªØµØºÙŠØ±ØŒ Ù†ÙØ¹Ø·ÙŠ wrapper Ø¹Ø±Ø¶ Ù…Ù†Ø·Ù‚ÙŠ */
  .page-wrap{ width: min(1280px, 100vw); margin: 0 auto; }

  .container{max-width:1200px;margin:auto;background:#fff;border:1px solid var(--line);border-radius:16px;padding:16px;margin-top:16px}
  h1,h2{color:var(--brand);margin:.2em 0 .6em}
  label{font-weight:700;display:block;margin:10px 0 6px}
  input,select,textarea,button{font-family:inherit}
  input,select,textarea{width:100%;padding:11px 12px;border:1px solid var(--line);border-radius:10px;font-size:15px;outline:none;background:#fff;color:#000}
  select option{color:#000}
  input:focus,select:focus,textarea:focus{border-color:#b7e2c8;box-shadow:0 0 0 3px rgba(23,151,75,.12)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:1024px){.row{grid-template-columns:1fr}}
  .row-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  @media (max-width:1024px){.row-3{grid-template-columns:1fr}}
  button{padding:12px 18px;background:var(--brand);color:#fff;border:none;border-radius:10px;cursor:pointer;font-weight:700}
  .btn-secondary{background:#0a6dd0}
  .btn-ghost{background:#eef4ff;color:#0a6dd0}
  .muted{color:var(--muted);font-size:14px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:16px auto 8px}
  .tab{padding:10px 14px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer;font-weight:700;color:#000}
  .tab.active{background:#eafff1;border-color:#cdebd8;color:#0b6b3d}
  .panel{display:none}
  .panel.active{display:block}
  .card{background:#f6fff9;border:1.5px solid #cfeedd;padding:14px;border-radius:12px;margin:10px 0}
  .table-wrap{width:100%;overflow:auto;border:1px solid var(--line);border-radius:12px;background:#fff}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--line);padding:9px 8px;text-align:right;font-size:14px;white-space:nowrap;color:#000}
  th{background:#f9fcff;position:sticky;top:0;z-index:1}

  /* Login modal */
  #loginModal{position:fixed;inset:0;background:#f0f2f5;display:flex;justify-content:center;align-items:center;z-index:99999}
  #loginModal .box{background:#fff;padding:28px;border-radius:14px;box-shadow:0 8px 30px rgba(0,0,0,.1);text-align:center;width:min(92vw,420px)}
  #loginModal input{padding:12px;font-size:16px;margin-top:12px;width:100%;border-radius:10px;border:1px solid var(--line)}

  /* Receipts picker */
  .picker-wrap{border:1px solid var(--line);border-radius:12px;padding:10px;background:#fff}
  .picker-toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
  #studentsPanel{display:block}
  #studentsSelect{width:100%;height:auto}

  /* Print preview block */
  #receiptPrint{display:none;margin-top:14px;border:1.5px dashed #bfe3cc;background:#fff;border-radius:12px;padding:16px}
  .print-head{display:flex;align-items:center;gap:12px}
  #receiptPrint .print-head img{height:60px;width:auto;object-fit:contain}
  #receiptPrint .print-head h3{margin:0;flex:1;text-align:center}

  .kv2{
    display:grid;
    grid-template-columns: 160px 1fr 160px 1fr;
    gap:8px 12px;
    align-items:center;
  }
  @media (max-width:700px){
    .kv2{ grid-template-columns: 140px 1fr; }
  }

  .signs{display:flex;justify-content:space-between;margin:20px 0 40px 0}
  .signs > div{font-weight:700;color:#333}
  .signs > div:first-child{min-width:100px;text-align:right}
  .signs > div:last-child{flex:1;text-align:center}

  /* Ø·Ø¨Ø§Ø¹Ø© Ø¹Ø§Ù…Ø© Ù„Ù„ØµÙØ­Ø© (Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙØ¹Ù„ÙŠØ© Ø¹Ø¨Ø± iframe) */
  @media print{
    @page{ size:A4; margin:12mm; }
    .no-print{ display:none !important; }
  }

  /* Ù‡Ø§ÙŠÙ„Ø§ÙŠØª Ù…Ø¤Ù‚Øª Ù„Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¹Ù†Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ */
  .flash-focus{animation: flash 1.6s ease-out 1}
  @keyframes flash{
    0%{box-shadow:0 0 0 0 rgba(23,151,75,.45)}
    60%{box-shadow:0 0 0 6px rgba(23,151,75,.18)}
    100%{box-shadow:none}
  }

  /* ======== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (ØªØ­ÙƒÙ… Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª) ======== */
  .ui-bar{display:flex;align-items:center;gap:8px;justify-content:space-between}
  .settings-btn{background:#fff;border:1px solid var(--line);border-radius:10px;padding:8px 12px;cursor:pointer}
  .settings-btn span{display:inline-block; transform: scale(var(--icon-zoom)); transform-origin:center;}
  .settings-panel{
    position:relative;
  }
  .settings-pop{
    position:absolute; inset-inline-end:0; top:42px; z-index:10;
    background:#fff; border:1px solid var(--line); border-radius:12px; padding:12px;
    min-width:260px; box-shadow:0 10px 24px rgba(0,0,0,.08);
    display:none;
  }
  .settings-pop.open{ display:block; }
  .settings-row{display:grid; grid-template-columns: 120px 1fr; gap:8px; align-items:center; margin:8px 0;}
  .settings-pop .muted{margin:8px 0 0; font-size:12px}

  /* ======== Overrides Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªØ¯Ø±Ù‘Ø¬ Ù…Ø¹ Ø§Ù„ØªØµØºÙŠØ± ======== */
  /* Ù†Ø®Ù„ÙŠ Ø§Ù„Ø¹Ù†Ø§ØµØ± ØªØ±Ø« Ø­Ø¬Ù… Ø§Ù„Ø®Ø· Ù…Ù† Ø§Ù„Ø¬Ø³Ù… Ø¨Ø¹Ø¯ Ø§Ù„ØªØµØºÙŠØ± */
  input,select,textarea,button{ font-size:1em; }
  th,td{ font-size:.9em; }
  .tab, .btn-secondary, .btn-ghost, button{ font-size:1em; }
  /* ØªØ­ÙƒÙ… Ø­Ø¬Ù… Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª (Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù†ØµÙŠØ©) */
  .tabs .tab, button, .link{ transform: scale(var(--icon-zoom)); transform-origin:center; }
</style>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>
<body>
<div class="page-wrap">

<!-- Ø´Ø±ÙŠØ· Ø¹Ù„ÙˆÙŠ ÙÙŠÙ‡ Ø²Ø± Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
<div class="container no-print">
  <div class="ui-bar">
    <div class="tabs" data-scope="main">
      <button class="tab active" data-panel="panel-home">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
      <button class="tab" data-panel="panel-students">ğŸ§‘â€ğŸ“ Ø§Ù„Ø·Ù„Ø§Ø¨</button>
      <button class="tab" data-panel="panel-receipts">ğŸ§¾ Ø§Ù„Ø¥ÙŠØµØ§Ù„Ø§Øª</button>
    </div>

    <div class="settings-panel">
      <button class="settings-btn no-print" id="openSettings"><span>âš™ï¸</span> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
      <div class="settings-pop" id="settingsPop">
        <div class="settings-row">
          <label>Ø­Ø¬Ù… Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©</label>
          <select id="uiZoomSelect">
            <option value="1">100%</option>
            <option value="0.9">90%</option>
            <option value="0.85">85%</option>
            <option value="0.8">80%</option>
            <option value="0.75">75%</option>
          </select>
        </div>
        <div class="settings-row">
          <label>Ø­Ø¬Ù… Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª</label>
          <select id="iconSizeSelect">
            <option value="0.9">ØµØºÙŠØ±</option>
            <option value="1">Ø¹Ø§Ø¯ÙŠ</option>
            <option value="1.1">ÙƒØ¨ÙŠØ±</option>
          </select>
        </div>
        <div class="toolbar" style="justify-content:flex-end;margin-top:6px">
          <button class="btn-secondary" id="saveUi">Ø­ÙØ¸</button>
          <button class="btn-ghost" id="closeSettings">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
        <div class="muted">*ÙƒÙ„ Ø¬Ù‡Ø§Ø² ÙŠÙ‚Ø¯Ø± ÙŠØ­ÙØ¸ Ø§Ø¹Ø¯Ø§Ø¯Ø§Øª Ø®Ø§ØµØ© Ø¨ÙŠÙ‡ Ø¹Ø´Ø§Ù† Ù…Ø­Ø¯Ø´ ÙŠØ¬ÙŠ Ø¹Ù„Ù‰ Ø­Ø¯</div>
      </div>
    </div>
  </div>
</div>

<!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
<div id="loginModal">
  <div class="box">
    <h2>ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
    <p class="muted">Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©</p>
    <input type="password" id="passwordInput" placeholder="*****" autofocus />
    <div style="margin-top:14px"><button id="loginBtn" onclick="checkPassword()">Ø¯Ø®ÙˆÙ„</button></div>
    <p id="loginError" style="color:#d10e0e;margin-top:10px;font-weight:700"></p>
  </div>
</div>

<!-- Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
<div id="panel-home" class="panel active" data-scope="main">
  <div class="container">
    <h2>Ù„ÙˆØ­Ø© Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ©</h2>
    <div class="row">
      <div class="card">
        <h3>Ø§Ù„Ø·Ù„Ø§Ø¨</h3>
        <p class="muted">ØªØ³Ø¬ÙŠÙ„ Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ØŒ Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØ¹Ø¯ÙŠÙ„.</p>
        <button class="btn-secondary" onclick="openTab('panel-students')">ÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</button>
      </div>
      <div class="card">
        <h3>Ø§Ù„Ø¥ÙŠØµØ§Ù„Ø§Øª</h3>
        <p class="muted">Ø¥Ù†Ø´Ø§Ø¡ Ø¥ÙŠØµØ§Ù„ØŒ Ø§Ù„Ø¨Ø­Ø«ØŒ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ§Ù„Ø·Ø¨Ø§Ø¹Ø©.</p>
        <button class="btn-secondary" onclick="openTab('panel-receipts')">ÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ø¥ÙŠØµØ§Ù„Ø§Øª</button>
      </div>
    </div>
  </div>
</div>

<!-- Ø§Ù„Ø·Ù„Ø§Ø¨ -->
<div id="panel-students" class="panel" data-scope="main">
  <div class="container">
    <h2>ğŸ§‘â€ğŸ“ ØªØ³Ø¬ÙŠÙ„ / ØªØ¹Ø¯ÙŠÙ„ Ø·Ø§Ù„Ø¨</h2>

    <form id="studentForm" onsubmit="submitStudent(event)">
      <input type="hidden" id="sMode" value="create" />
      <input type="hidden" id="prevStudentId" value="" />

      <div class="row">
        <div>
          <label>Ø§Ù„Ø§Ø³Ù…</label>
          <input id="sName" required />
        </div>
        <div>
          <label>Ø§Ù„Ù†ÙˆØ¹</label>
          <select id="sGender">
            <option value="">â€” Ø§Ø®ØªØ± â€”</option>
            <option value="Ø°ÙƒØ±">Ø°ÙƒØ±</option>
            <option value="Ø£Ù†Ø«Ù‰">Ø£Ù†Ø«Ù‰</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Ø§Ù„Ù‡Ø§ØªÙ (11â€“15 Ø±Ù‚Ù…)</label>
          <input id="sPhone1" inputmode="numeric" pattern="\d{11,15}" title="Ù…Ù† 12 Ø¥Ù„Ù‰ 15 Ø±Ù‚Ù…" required />
        </div>
        <div>
          <label>Ù‡Ø§ØªÙ Ø¨Ø¯ÙŠÙ„</label>
          <input id="sPhone2" inputmode="numeric" pattern="\d{0,15}" title="Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Ø§Ù„Ø¹Ù…Ø±</label>
          <input id="sAge" inputmode="numeric" pattern="\d{1,2}" title="Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·" />
        </div>
        <div>
          <label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
          <input id="sAddress" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Ø§Ù„Ù…Ø±Ø­Ù„Ø© / Ø§Ù„Ù…Ø³ØªÙˆÙ‰</label>
          <select id="sLevel">
            <option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªÙˆÙ‰ â€”</option>
          </select>
        </div>
        <div>
          <label>Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</label>
          <input id="sSchool" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø£Ø¨</label>
          <input id="sFjob" />
        </div>
        <div>
          <label>ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø£Ù…</label>
          <input id="sMjob" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Ø®Ø¨Ø±Ø§Øª Ø³Ø§Ø¨Ù‚Ø©</label>
          <input id="sExp" />
        </div>
        <div>
          <label>Ø§Ù„ÙØ±Ø¹</label>
          <select id="sBranch" required></select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ)</label>
          <input id="sId" placeholder="Ø³ÙŠØ¨Ù‡ ÙØ§Ø¶ÙŠ ÙˆØ¨ÙŠØªØ¹Ø¯Ù„ ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø¶Ø±ÙˆØ±Ø©" />
        </div>
        <div class="toolbar" style="align-items:flex-end">
          <button type="submit" id="sSubmit">ğŸ’¾ Ø­ÙØ¸</button>
          <button type="button" class="btn-ghost" onclick="resetStudentForm()">Ù…Ø³Ø­</button>
        </div>
      </div>

      <div id="sMsg" class="muted" style="margin-top:8px"></div>
    </form>

    <div class="card" style="margin-top:14px">
      <h3>Ø¨Ø­Ø« ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø§Ø¨</h3>
      <div class="toolbar" style="gap:8px">
        <select id="sBranchFilter" style="min-width:180px"></select>
        <input id="sQ" placeholder="Ø¨Ø­Ø« Ø¹Ø§Ù… (Ø§Ø³Ù…/ID/Ù‡Ø§ØªÙ/ÙØ±Ø¹)" />
        <button class="link" onclick="searchStudents()">Ø¨Ø­Ø« Ø¹Ø§Ù…</button>
        <button class="link" onclick="listStudentsByBranch()">Ø¹Ø±Ø¶ Ø­Ø³Ø¨ Ø§Ù„ÙØ±Ø¹</button>
      </div>
      <div class="table-wrap" style="margin-top:10px"><table>
        <thead id="sHead"></thead>
        <tbody id="sBody"></tbody>
      </table></div>
    </div>
  </div>
</div>

<!-- Ø§Ù„Ø¥ÙŠØµØ§Ù„Ø§Øª -->
<div id="panel-receipts" class="panel" data-scope="main">
  <div class="container">
    <h2>ğŸ§¾ Ø§Ù„Ø¥ÙŠØµØ§Ù„Ø§Øª â€” Ø¥Ù†Ø´Ø§Ø¡ / ØªØ¹Ø¯ÙŠÙ„ / Ø¨Ø­Ø«</h2>

    <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø·Ø§Ù„Ø¨ -->
    <div class="card">
      <label>Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø·Ø§Ù„Ø¨</label>

      <div class="picker-wrap">
        <div class="picker-toolbar">
          <button type="button" class="btn-secondary" id="btnToggleStudents">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ â¬‡ï¸</button>
          <input id="studentsFilter" placeholder="Ø§ÙƒØªØ¨ Ù„ØªØµÙÙŠØ© Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ / Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ â€” Enter Ù„Ø§Ø®ØªÙŠØ§Ø± Ø£ÙˆÙ„ Ù†ØªÙŠØ¬Ø©" style="flex:1" />
          <button type="button" class="btn-ghost" id="btnClearPick">Ù…Ø³Ø­ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±</button>
        </div>

        <div id="studentsPanel">
          <select id="studentsSelect" size="8"></select>
        </div>
      </div>

      <small class="muted" id="studentsDiag"></small>
    </div>

    <form id="receiptForm" onsubmit="submitReceipt(event)">
      <input type="hidden" id="rMode" value="create" />
      <input type="hidden" id="prevReceiptId" value="" />
      <input type="hidden" id="rStudentId" value="" />

      <div class="row">
        <div>
          <label>Ø§Ù„ÙØ±Ø¹</label>
          <select id="rBranch" required></select>
        </div>
        <div>
          <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ÙŠØµØ§Ù„</label>
          <input id="rDate" type="datetime-local" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</label>
          <input id="rCustomer" readonly placeholder="ÙŠÙÙ…Ù„Ø£ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±" />
        </div>
        <div>
          <label>Ø§Ù„ÙƒÙˆØ±Ø³</label>
          <input id="rCourse" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Ø§Ù„Ù‚ÙŠÙ…Ø©</label>
          <input id="rAmount" inputmode="numeric" pattern="\d+(\.\d{1,2})?" title="Ø±Ù‚Ù… ÙÙ‚Ø·" required />
        </div>
        <div>
          <label>Ø§Ù„Ø¯ÙØ¹Ø©</label>
          <select id="rInstallment" required>
            <option value="1">1</option><option value="2">2</option><option value="3">3</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…</label>
          <input id="rReceiver" placeholder="Ù…Ø«Ø§Ù„: Ø£/ Ù…Ø­Ù…Ø¯ Ø¹Ù„ÙŠ" />
        </div>
        <div>
          <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
          <input id="rNotes" />
        </div>
      </div>

      <div class="card">
        <div class="toolbar">
          <span class="muted">ID Ø§Ù„Ø¥ÙŠØµØ§Ù„ (Ø¹Ø±Ø¶):</span>
          <strong id="ridView">â€”</strong>
          <span class="muted" id="ridHint"></span>
        </div>
      </div>

      <div class="toolbar" style="margin-top:10px">
        <button type="submit" id="rSubmitBtn">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¥ÙŠØµØ§Ù„</button>
        <button class="btn-secondary" type="button" onclick="printReceipt()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
        <button class="link" type="button" onclick="downloadPDF()">â¬‡ï¸ ØªÙ†Ø²ÙŠÙ„ PDF</button>
        <button class="link" type="button" onclick="resetReceiptForm()">Ù…Ø³Ø­</button>
      </div>
      <div id="rMsg" class="muted" style="margin-top:8px"></div>
    </form>

    <div class="card" style="margin-top:14px">
      <div class="toolbar" style="gap:8px">
        <select id="recBranchFilter" style="min-width:180px"></select>
        <input id="recQ" placeholder="Ø¨Ø­Ø« (Ø§Ø³Ù…/ID/ÙØ±Ø¹/Ù…Ø¨Ù„Øº/ÙƒÙˆØ±Ø³/Ø¯ÙØ¹Ø©/Ù…Ø³ØªÙ„Ù…)" />
        <button class="link" onclick="searchReceipts()">Ø¨Ø­Ø«</button>
        <button class="link" onclick="listAllReceipts()">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</button>
      </div>
      <div class="table-wrap" style="margin-top:10px"><table>
        <thead id="recHead"></thead>
        <tbody id="recBody"></tbody>
      </table></div>
    </div>

    <div id="receiptPrint">
      <div class="print-head" style="display:flex;align-items:center;justify-content:space-between;flex-direction:row-reverse;">
        <img src="logo.png" alt="Logo" style="height:30px;object-fit:contain;">
        <h3 style="margin:0;flex:1;text-align:center;">Ø¥ÙŠØµØ§Ù„ Ø¯ÙØ¹</h3>
        <button type="button" class="btn-secondary no-print" onclick="printReceipt()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
      </div>
      <div class="kv2">
        <div class="k">Ø±Ù‚Ù… Ø§Ù„Ø¥ÙŠØµØ§Ù„:</div><div class="v" id="pvReceiptId"></div>
        <div class="k">Ø§Ù„ØªØ§Ø±ÙŠØ®:</div><div class="v" id="pvDate"></div>
        <div class="k">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„:</div><div class="v" id="pvCustomer"></div>
        <div class="k">Ø§Ù„Ù‚ÙŠÙ…Ø©:</div><div class="v" id="pvAmount"></div>
        <div class="k">Ø§Ù„ÙƒÙˆØ±Ø³:</div><div class="v" id="pvCourse"></div>
        <div class="k">Ø§Ù„Ø¯ÙØ¹Ø©:</div><div class="v" id="pvInstallment"></div>
        <div class="k">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…:</div><div class="v" id="pvReceiver"></div>
        <div class="k">Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</div><div class="v" id="pvNotes"></div>
        <div class="k">Ø§Ù„ÙØ±Ø¹:</div><div class="v" id="pvBranch"></div>
      </div>
      <div class="signs">
        <div>Ø§Ù„Ø®ØªÙ…</div>
        <div>Ø§Ù„ØªÙˆÙ‚ÙŠØ¹</div>
      </div>
    </div>
  </div>
</div>

</div><!-- /page-wrap -->

<script>
/* ================= Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ© ================= */
const url = "https://script.google.com/macros/s/AKfycbxHOvORBDx8Jz7Dhi0uFV42h3OUbYdWNVZVZ-gsVO5o85CUrN6NiqwcllPN-knMTsM5/exec";

/* ================= ØªØ®Ø²ÙŠÙ† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (LocalStorage) ================= */
const UI_STORAGE_KEY = "academy_ui_settings_v1";
function loadUiSettings(){
  try{
    const raw = localStorage.getItem(UI_STORAGE_KEY);
    if(!raw) return { uiZoom: "1", iconZoom: "1" };
    const parsed = JSON.parse(raw);
    return {
      uiZoom: String(parsed.uiZoom || "1"),
      iconZoom: String(parsed.iconZoom || "1")
    };
  }catch{ return { uiZoom:"1", iconZoom:"1" }; }
}
function applyUiSettings(s){
  document.documentElement.style.setProperty('--ui-zoom', s.uiZoom || "1");
  document.documentElement.style.setProperty('--icon-zoom', s.iconZoom || "1");
  const zSel = document.getElementById('uiZoomSelect');
  const iSel = document.getElementById('iconSizeSelect');
  if(zSel) zSel.value = s.uiZoom || "1";
  if(iSel) iSel.value = s.iconZoom || "1";
}
function saveUiSettings(){
  const uiZoom = document.getElementById('uiZoomSelect').value;
  const iconZoom = document.getElementById('iconSizeSelect').value;
  const s = { uiZoom, iconZoom };
  localStorage.setItem(UI_STORAGE_KEY, JSON.stringify(s));
  applyUiSettings(s);
}

/* ================= ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ================= */
let realPassword = "";
function focusPassword(){ const i=document.getElementById('passwordInput'); if(i){i.focus(); i.select?.();} }
document.addEventListener('DOMContentLoaded', ()=>{
  focusPassword();
  // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙÙˆØ± Ø§Ù„ØªØ­Ù…ÙŠÙ„
  applyUiSettings(loadUiSettings());

  // ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
  const btn = document.getElementById('openSettings');
  const box = document.getElementById('settingsPop');
  const close = document.getElementById('closeSettings');
  const save = document.getElementById('saveUi');
  btn?.addEventListener('click', ()=> box.classList.toggle('open'));
  close?.addEventListener('click', ()=> box.classList.remove('open'));
  save?.addEventListener('click', ()=>{ saveUiSettings(); box.classList.remove('open'); });
  // Ø§ØºÙ„Ø§Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø®Ø§Ø±Ø¬ Ø§Ù„Ø¨ÙˆÙƒØ³
  document.addEventListener('click', (e)=>{
    if(!box) return;
    const inside = box.contains(e.target) || btn.contains(e.target);
    if(!inside) box.classList.remove('open');
  });
});

fetch(url + "?getpass=1",{headers:{'Accept':'application/json'}}).then(r=>r.json()).then(d=>{
  realPassword = (d.password||"").toString().trim();
  document.body.classList.add('ready');
  focusPassword();
  initCommon();
}).catch(()=>{
  document.body.classList.add('ready');
  document.getElementById('loginError').textContent = "ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¨Ø§Ø³ÙˆÙˆØ±Ø¯ Ù…Ù† Ø§Ù„Ø´ÙŠØª.";
});
function checkPassword(){
  const v=document.getElementById('passwordInput').value.trim();
  if(v===realPassword){ document.getElementById('loginModal').style.display='none'; }
  else { document.getElementById('loginError').textContent = "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©!"; }
}
document.getElementById('passwordInput').addEventListener('keydown', e=>{
  if(e.key==='Enter'){ e.preventDefault(); document.getElementById('loginBtn').click(); }
});

/* ================= ØªØ¨ÙˆÙŠØ¨Ø§Øª ================= */
function openTab(id){
  document.querySelectorAll('.tabs .tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.panel[data-scope="main"]').forEach(p=>p.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelector(`.tabs [data-panel="${id}"]`)?.classList.add('active');
  if(id==='panel-receipts'){ openStudentsPanel(); }
}
document.querySelectorAll('.tabs').forEach(group=>{
  const scope = group.dataset.scope;
  group.querySelectorAll('.tab').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      group.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
      btn.classList.add('active');
      const target = btn.dataset.panel;
      document.querySelectorAll(`.panel[data-scope="${scope}"]`).forEach(p=>p.classList.remove('active'));
      document.getElementById(target).classList.add('active');
      if(target==='panel-receipts'){ openStudentsPanel(); }
    });
  });
});

/* ================= Helpers ================= */
const setVal=(id,v)=>{ const el=document.getElementById(id); if(el) el.value=v??""; };
const setText=(id,v)=>{ const el=document.getElementById(id); if(el) el.textContent=v??""; };
async function getOnlineNow(){
  try{
    const r = await fetch('https://worldtimeapi.org/api/timezone/Africa/Cairo');
    const d = await r.json();
    return d.datetime.slice(0,16);
  }catch{
    const x=new Date(), p=v=>String(v).padStart(2,'0');
    return `${x.getFullYear()}-${p(x.getMonth()+1)}-${p(x.getDate())}T${p(x.getHours())}:${p(x.getMinutes())}`;
  }
}

/* ==== ØªØ·Ø¨ÙŠØ¹ Ø§Ù„Ù†Øµ Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ù„Ù„Ø¨Ø­Ø« ==== */
function normalizeArabic(str){
  if(str==null) return "";
  let s = String(str);
  const arabicNums = {'Ù ':'0','Ù¡':'1','Ù¢':'2','Ù£':'3','Ù¤':'4','Ù¥':'5','Ù¦':'6','Ù§':'7','Ù¨':'8','Ù©':'9'};
  const persianNums= {'Û°':'0','Û±':'1','Û²':'2','Û³':'3','Û´':'4','Ûµ':'5','Û¶':'6','Û·':'7','Û¸':'8','Û¹':'9'};
  s = s.replace(/[Ù -Ù©]/g, d=>arabicNums[d]).replace(/[Û°-Û¹]/g, d=>persianNums[d]);
  s = s.replace(/[\u064B-\u065F\u0670]/g,'').replace(/\u0640/g,'');
  s = s.replace(/[Ø£Ø¥Ø¢]/g,'Ø§').replace(/Ù‰/g,'ÙŠ').replace(/Ø©/g,'Ù‡').replace(/Ø¤/g,'Ùˆ').replace(/Ø¦/g,'ÙŠ');
  return s.toLowerCase().trim().replace(/\s+/g,' ');
}
function toKey(student){
  const parts = [student.name||'', student.id||'', student.branch||'', student.schoolLevel||''];
  return normalizeArabic(parts.join(' '));
}

/* ====== Ø¹Ø±Ø¶ Serial Ù…Ø®ØµØµ ====== */
let RECEIPT_ORDER_CACHE = { map:new Map(), counts:{} };
async function buildReceiptOrderCache(){
  try{
    const d = await fetch(url + "?searchReceipts=1&q=",{headers:{'Accept':'application/json'}}).then(r=>r.json());
    const rows = (d&&d.results) ? d.results.slice() : [];
    rows.sort((a,b)=>(parseInt(a.serial||0)-parseInt(b.serial||0)));
    const by = {};
    rows.forEach(r=>{
      const bc = String(r.branchCode||'').trim();
      if(!by[bc]) by[bc]=[];
      by[bc].push(r);
    });
    const map = new Map();
    const counts = {};
    Object.entries(by).forEach(([bc,list])=>{
      counts[bc] = list.length;
      list.forEach((r,idx)=> map.set(`${bc}|${r.serial}`, idx+1));
    });
    RECEIPT_ORDER_CACHE = { map, counts };
  }catch{
    RECEIPT_ORDER_CACHE = { map:new Map(), counts:{} };
  }
}
function displaySerial(branchCode, ordinal){
  const bc = String(parseInt(branchCode||0,10)).padStart(2,'0'); // âœ… Ø±Ù‚Ù…ÙŠÙ†
  const n  = parseInt(ordinal||0,10);
  if(!bc || isNaN(n) || n<=0) return "";
  return bc + String(n).padStart(6,'0');
}
function displaySerialForRow(r){
  const bc = String(r.branchCode||'').trim();
  const ord = RECEIPT_ORDER_CACHE.map.get(`${bc}|${r.serial}`) || 0;
  return displaySerial(bc, ord);
}

/* ================= Ù…Ø´ØªØ±ÙƒØ© ================= */
async function loadBranchesTo(selectId){
  try{
    const data = await fetch(url + "?listBranches=1",{headers:{'Accept':'application/json'}}).then(r=>r.json());
    const arr = (data && data.results) ? data.results : [{name:'Ù…ØµØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©'},{name:'Ø´Ø¨Ø±Ø§ Ù…ØµØ±'}];
    const sel = document.getElementById(selectId);
    if (!sel) return;
    sel.innerHTML = `<option value="" ${selectId!=='recBranchFilter'?'disabled selected':''}>${selectId!=='recBranchFilter'?'â€” Ø§Ø®ØªØ± Ø§Ù„ÙØ±Ø¹ â€”':'ÙƒÙ„ Ø§Ù„ÙØ±ÙˆØ¹'}</option>` +
      arr.map(b=>`<option value="${b.name}">${b.name}</option>`).join('');
  }catch{
    const sel = document.getElementById(selectId);
    if (!sel) return;
    sel.innerHTML = `<option value="" ${selectId!=='recBranchFilter'?'disabled selected':''}>${selectId!=='recBranchFilter'?'â€” Ø§Ø®ØªØ± Ø§Ù„ÙØ±Ø¹ â€”':'ÙƒÙ„ Ø§Ù„ÙØ±ÙˆØ¹'}</option>` +
      `<option value="Ù…ØµØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©">Ù…ØµØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</option><option value="Ø´Ø¨Ø±Ø§ Ù…ØµØ±">Ø´Ø¨Ø±Ø§ Ù…ØµØ±</option>`;
  }
}
async function loadLevelsTo(selectId){
  try{
    const data = await fetch(url + "?listLevels=1",{headers:{'Accept':'application/json'}}).then(r=>r.json());
    const arr = (data && data.results && data.results.length) ? data.results : ["Level 1","Level 2","Level 3","Level 4"];
    const sel = document.getElementById(selectId);
    if(!sel) return;
    sel.innerHTML = `<option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªÙˆÙ‰ â€”</option>` + arr.map(v=>`<option value="${v}">${v}</option>`).join('');
  }catch{
    const sel = document.getElementById(selectId);
    if(!sel) return;
    sel.innerHTML = `<option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªÙˆÙ‰ â€”</option>
      <option>Level 1</option><option>Level 2</option><option>Level 3</option><option>Level 4</option>`;
  }
}
async function initCommon(){
  await loadBranchesTo('sBranch');
  await loadBranchesTo('sBranchFilter');
  await loadLevelsTo('sLevel');
  await loadBranchesTo('rBranch');
  await loadBranchesTo('recBranchFilter');
  setVal('rDate', await getOnlineNow());
  initStudentsPage();
  await initReceiptsPage();
}

/* ==================== Ø§Ù„Ø·Ù„Ø§Ø¨ ==================== */
function resetStudentForm(){
  document.getElementById('studentForm').reset();
  document.getElementById('sMode').value='create';
  document.getElementById('sSubmit').textContent='ğŸ’¾ Ø­ÙØ¸';
  setVal('prevStudentId','');
  document.getElementById('sMsg').textContent='';
}
async function submitStudent(e){
  e.preventDefault();
  const mode = document.getElementById('sMode').value;
  const fd = new FormData();
  if (mode==='edit'){ fd.append('action','updateStudent'); fd.append('prevId', document.getElementById('prevStudentId').value.trim()); }
  else { fd.append('formType','student'); }
  fd.append('name', document.getElementById('sName').value.trim());
  fd.append('gender', document.getElementById('sGender').value.trim());
  fd.append('primaryPhone', document.getElementById('sPhone1').value.trim());
  fd.append('altPhone', document.getElementById('sPhone2').value.trim());
  fd.append('age', document.getElementById('sAge').value.trim());
  fd.append('address', document.getElementById('sAddress').value.trim());
  fd.append('schoolLevel', document.getElementById('sLevel').value.trim());
  fd.append('schoolName', document.getElementById('sSchool').value.trim());
  fd.append('fatherJob', document.getElementById('sFjob').value.trim());
  fd.append('motherJob', document.getElementById('sMjob').value.trim());
  fd.append('previousExperience', document.getElementById('sExp').value.trim());
  fd.append('branch', document.getElementById('sBranch').value.trim());
  const manualId = document.getElementById('sId').value.trim();
  if (manualId) fd.append('studentId', manualId);
  const msg = document.getElementById('sMsg');
  msg.textContent = mode==='edit' ? 'â³ Ø¬Ø§Ø±Ù Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„...' : 'â³ Ø¬Ø§Ø±Ù Ø§Ù„Ø­ÙØ¸...';
  try{
    const d = await fetch(url,{method:'POST',body:fd}).then(r=>r.json());
    if (d && d.result==='OK'){
      const newId = d.id || document.getElementById('sId').value.trim() || '';
      msg.textContent = mode==='edit' ? 'âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„' : `ğŸ†• ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ â€” ID: ${newId}`;
      if(newId){ setVal('sQ', newId); await searchStudents(); } else { await searchStudents(); }
      if (mode!=='edit') {
        const keepBranch = document.getElementById('sBranch').value;
        resetStudentForm();
        document.getElementById('sBranch').value = keepBranch;
      } else {
        document.getElementById('panel-students').scrollIntoView({behavior:'smooth', block:'start'});
        document.getElementById('sName').classList.add('flash-focus');
        document.getElementById('sGender').classList.add('flash-focus');
        setTimeout(()=>{
          document.getElementById('sName').classList.remove('flash-focus');
          document.getElementById('sGender').classList.remove('flash-focus');
        },1700);
      }
    } else if (d && d.code==='DUPLICATE_ID'){
      msg.textContent = 'âŒ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¨Ù‚Ù‹Ø§';
    } else { msg.textContent = 'âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸'; }
  }catch{ msg.textContent = 'âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„'; }
}
function initStudentsPage(){
  document.getElementById('sPhone1').addEventListener('input', e=> e.target.value=e.target.value.replace(/\D/g,''));
  document.getElementById('sPhone2').addEventListener('input', e=> e.target.value=e.target.value.replace(/\D/g,''));
}
function searchStudents(){
  const q = document.getElementById('sQ').value.trim();
  return fetch(url + "?searchStudents=1&q=" + encodeURIComponent(q))
    .then(r=>r.json()).then(data=>{
      const rows = (data && data.results) ? data.results : [];
      renderStudentsTable(rows);
    }).catch(()=> renderStudentsTable([]));
}
function listStudentsByBranch(){
  const b = document.getElementById('sBranchFilter').value;
  const ep = url + "?listStudentsByBranch=1" + (b? "&branch=" + encodeURIComponent(b) : "");
  fetch(ep).then(r=>r.json()).then(d=>{
    const rows = (d && d.results) ? d.results : [];
    renderStudentsTable(rows);
  }).catch(()=> renderStudentsTable([]));
}
function renderStudentsTable(rows){
  const head=document.getElementById('sHead'), body=document.getElementById('sBody');
  head.innerHTML = "<tr>" + ["ID","Ø§Ù„Ø§Ø³Ù…","Ø§Ù„Ù‡Ø§ØªÙ","Ø§Ù„ÙØ±Ø¹","Ø§Ù„Ù…Ø³ØªÙˆÙ‰","Ø§Ù„ØªØ§Ø±ÙŠØ®","ØªØ­ÙƒÙ…"].map(h=>`<th>${h}</th>`).join("") + "</tr>";
  if (!rows.length){ body.innerHTML = "<tr><td class='muted'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬.</td></tr>"; return; }
  body.innerHTML = rows.map(r=>`
    <tr>
      <td>${r.id||""}</td>
      <td>${r.name||""}</td>
      <td>${r.primaryPhone||""}</td>
      <td>${r.branch||""}</td>
      <td>${r.schoolLevel||""}</td>
      <td>${r.date||""}</td>
      <td><button class="link" type="button" onclick='editStudent(${JSON.stringify(r).replace(/'/g,"&#39;")})'>ØªØ¹Ø¯ÙŠÙ„</button></td>
    </tr>
  `).join("");
}
function editStudent(s){
  openTab('panel-students');
  setVal('sName', s.name||"");
  setVal('sGender', s.gender||"");
  setVal('sPhone1', s.primaryPhone||"");
  setVal('sPhone2', s.altPhone||"");
  setVal('sAge', s.age||"");
  setVal('sAddress', s.address||"");
  setVal('sLevel', s.schoolLevel||"");
  setVal('sSchool', s.schoolName||"");
  setVal('sFjob', s.fatherJob||"");
  setVal('sMjob', s.motherJob||"");
  setVal('sExp', s.previousExperience||"");
  setVal('sBranch', s.branch||"");
  setVal('sId', s.id||"");
  document.getElementById('sMode').value='edit';
  document.getElementById('sSubmit').textContent='ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„';
  setVal('prevStudentId', s.id||"");
  document.getElementById('sMsg').textContent = `ØªØ­Ø±ÙŠØ±: ${s.name||''}`;
  document.getElementById('panel-students').scrollIntoView({behavior:'smooth', block:'start'});
  document.getElementById('sName').classList.add('flash-focus');
  document.getElementById('sGender').classList.add('flash-focus');
  setTimeout(()=>{
    document.getElementById('sName').classList.remove('flash-focus');
    document.getElementById('sGender').classList.remove('flash-focus');
  },1700);
}

/* ==================== Ø§Ù„Ø¥ÙŠØµØ§Ù„Ø§Øª ==================== */
let STUDENTS_CACHE = [];
let TOTAL_STUDENTS = 0;

// type-ahead
let selectTypeBuffer = "";
let lastTypeTime = 0;

async function initReceiptsPage(){
  document.getElementById('rBranch').addEventListener('change', async ()=>{
    setVal('rDate', await getOnlineNow());
  });
  setVal('rDate', await getOnlineNow());
  document.getElementById('rAmount').addEventListener('input', e=> e.target.value=e.target.value.replace(/[^0-9.]/g,''));

  await preloadStudents();
  bindStudentsPicker();

  await buildReceiptOrderCache();

  openStudentsPanel();
  listAllReceipts();
}

async function preloadStudents(){
  const diag = document.getElementById('studentsDiag');
  diag.textContent = "â³ Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨...";
  try{
    const r = await fetch(url + "?listStudentsBasic=1",{headers:{'Accept':'application/json'}});
    const d = await r.json();
    const arr = (d && d.results) ? d.results : [];
    STUDENTS_CACHE = Array.isArray(arr)
      ? arr.filter(x=>x && (x.name||x.id)).map(s=>({ ...s, _key: toKey(s) }))
      : [];
    TOTAL_STUDENTS = STUDENTS_CACHE.length;
    diag.textContent = `âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${TOTAL_STUDENTS} Ø·Ø§Ù„Ø¨/Ø·Ø§Ù„Ø¨Ø©.`;
  }catch(e){
    STUDENTS_CACHE = [];
    TOTAL_STUDENTS = 0;
    diag.textContent = "âš ï¸ Ù„Ù… Ø£Ø³ØªØ·Ø¹ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡.";
  }
}
function updateStudentsCount(current){
  const diag = document.getElementById('studentsDiag');
  if (TOTAL_STUDENTS===0) return;
  diag.textContent = `Ø§Ù„Ù†ØªØ§Ø¦Ø¬: ${current} Ù…Ù† ${TOTAL_STUDENTS} â€” Ø§Ø¶ØºØ· Enter Ù„Ø§Ø®ØªÙŠØ§Ø± Ø£ÙˆÙ„ Ù†ØªÙŠØ¬Ø©`;
}
function fillStudentsSelect(list){
  const sel = document.getElementById('studentsSelect');
  sel.innerHTML = '';
  if (!list || !list.length){
    const opt = document.createElement('option');
    opt.disabled = true;
    opt.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø©';
    sel.appendChild(opt);
    updateStudentsCount(0);
    return;
  }
  list.forEach(st=>{
    const opt = document.createElement('option');
    opt.value = st.id || '';
    opt.textContent = `${st.name||''} â€” ${st.id||''} (${st.branch||''})`;
    opt.dataset.branch = st.branch||'';
    opt.dataset.level  = st.schoolLevel||'';
    opt.dataset.name   = st.name||'';
    opt.dataset.key    = st._key||'';
    sel.appendChild(opt);
  });
  sel.selectedIndex = 0;
  updateStudentsCount(list.length);
}
function localFilterStudents(q){
  const nq = normalizeArabic(q||'');
  if (!nq) return STUDENTS_CACHE.slice();
  const tokens = nq.split(' ').filter(Boolean);
  return STUDENTS_CACHE.filter(s => tokens.every(t => s._key.includes(t)));
}
function applyFilterAndRender(q){
  const list = localFilterStudents(q);
  fillStudentsSelect(list);
  return list;
}
function pickFromOption(opt){
  if (!opt || opt.disabled) return;
  const id    = opt.value || '';
  const name  = opt.dataset.name || '';
  const branch= opt.dataset.branch || '';
  const level = opt.dataset.level || '';
  setVal('rStudentId', id);
  setVal('rCustomer', name);
  if (branch) document.getElementById('rBranch').value = branch;

  const courseInput = document.getElementById('rCourse');
  courseInput.value = level || '';
  courseInput.readOnly = true;
  courseInput.style.background = '#f8fafc';

  fillPreview(null);
}
function bindStudentsPicker(){
  const btnToggle = document.getElementById('btnToggleStudents');
  const panel     = document.getElementById('studentsPanel');
  const sel       = document.getElementById('studentsSelect');
  const filter    = document.getElementById('studentsFilter');
  const clearBtn  = document.getElementById('btnClearPick');

  fillStudentsSelect(STUDENTS_CACHE);

  btnToggle.addEventListener('click', ()=>{
    panel.style.display = (panel.style.display==='none' || !panel.style.display) ? 'block' : 'none';
    if (panel.style.display==='block'){ filter.focus(); }
  });

  let t=null;
  filter.addEventListener('input', e=>{
    clearTimeout(t);
    const q=e.target.value;
    t=setTimeout(()=> applyFilterAndRender(q), 60);
  });

  filter.addEventListener('keydown', e=>{
    if (e.key === 'ArrowDown'){
      e.preventDefault();
      if (sel.options.length>0){ sel.focus(); sel.selectedIndex = Math.max(sel.selectedIndex, 0); }
    }
    if (e.key === 'Enter'){
      e.preventDefault();
      if (sel.options.length===0){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø©.'); return; }
      const opt = sel.options[sel.selectedIndex >= 0 ? sel.selectedIndex : 0];
      pickFromOption(opt);
    }
  });

  sel.addEventListener('change', ()=>{
    const opt = sel.selectedOptions[0];
    pickFromOption(opt);
  });

  sel.addEventListener('keydown', (e)=>{
    const now = Date.now();
    if (now - lastTypeTime > 800) selectTypeBuffer = "";
    lastTypeTime = now;

    if (/^[\w\u0600-\u06FF\s]$/.test(e.key) && !e.ctrlKey && !e.metaKey && !e.altKey){
      selectTypeBuffer += e.key;
      const look = normalizeArabic(selectTypeBuffer);
      const opts = Array.from(sel.options);
      const idx = opts.findIndex(o => (o.dataset.key||normalizeArabic(o.textContent||'')).includes(look));
      if (idx >= 0){ sel.selectedIndex = idx; }
    }

    if (e.key === 'Enter'){
      e.preventDefault();
      const opt = sel.selectedOptions[0];
      pickFromOption(opt);
    }
  });

  sel.addEventListener('dblclick', ()=>{
    const opt = sel.selectedOptions[0];
    pickFromOption(opt);
  });

  clearBtn.addEventListener('click', ()=>{
    setVal('studentsFilter','');
    fillStudentsSelect(STUDENTS_CACHE);
    setVal('rStudentId',''); setVal('rCustomer','');
    const courseInput = document.getElementById('rCourse');
    courseInput.readOnly = false;
    courseInput.style.background = '';
    courseInput.value = '';
    sel.selectedIndex = -1;
    filter.focus();
  });
}
function openStudentsPanel(){
  const panel  = document.getElementById('studentsPanel');
  const filter = document.getElementById('studentsFilter');
  panel.style.display='block';
  filter.focus();
}

/* ====== ÙØ­Øµ Ø§ÙƒØªÙ…Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥ÙŠØµØ§Ù„ Ù‚Ø¨Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ====== */
function validateReceiptForm(){
  const branch = document.getElementById('rBranch').value.trim();
  const date   = document.getElementById('rDate').value.trim();
  const sid    = document.getElementById('rStudentId').value.trim();
  const name   = document.getElementById('rCustomer').value.trim();
  const amount = document.getElementById('rAmount').value.trim();
  const course = document.getElementById('rCourse').value.trim();
  const inst   = document.getElementById('rInstallment').value.trim();
  const recv   = document.getElementById('rReceiver').value.trim();

  const errs = [];
  if(!branch) errs.push('Ø§Ù„ÙØ±Ø¹');
  if(!date)   errs.push('Ø§Ù„ØªØ§Ø±ÙŠØ®');
  if(!sid || !name) errs.push('Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ (Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©)');
  if(!amount || !/^\d+(\.\d{1,2})?$/.test(amount)) errs.push('Ø§Ù„Ù‚ÙŠÙ…Ø© (Ø±Ù‚Ù… ØµØ­ÙŠØ­)');
  if(!course) errs.push('Ø§Ù„ÙƒÙˆØ±Ø³');
  if(!inst)   errs.push('Ø§Ù„Ø¯ÙØ¹Ø©');
  if(!recv)   errs.push('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…');

  if (errs.length){
    alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ù‚Ø¨Ù„ Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:\n- ' + errs.join('\n- '));
    return false;
  }
  return true;
}

/* ====== Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© (Ø¥Ù†Ø´Ø§Ø¡/ØªØ¹Ø¯ÙŠÙ„) ====== */
async function saveReceiptIfNeeded(){
  const mode = document.getElementById('rMode').value;
  const fd = new FormData();
  if(mode==='edit'){
    fd.append('action','updateReceipt');
    fd.append('prevReceiptId', document.getElementById('prevReceiptId').value.trim());
  } else {
    fd.append('formType','receipt');
  }
  fd.append('branch', document.getElementById('rBranch').value.trim());
  const raw = document.getElementById('rDate').value;
  fd.append('date', raw? new Date(raw).toISOString() : "");
  fd.append('customer', document.getElementById('rCustomer').value.trim());
  fd.append('amount', document.getElementById('rAmount').value.trim());
  fd.append('course', document.getElementById('rCourse').value.trim());
  fd.append('installment', document.getElementById('rInstallment').value);
  fd.append('notes', document.getElementById('rNotes').value.trim());
  fd.append('receiverName', document.getElementById('rReceiver').value.trim());

  const d = await fetch(url, {method:'POST', body:fd}).then(r=>r.json());
  if(!(d && d.result==='OK')) throw new Error('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©');

  await buildReceiptOrderCache();
  const bc = String(d.branchCode||'').trim();
  const ord = RECEIPT_ORDER_CACHE.map.get(`${bc}|${d.serial}`) || (RECEIPT_ORDER_CACHE.counts[bc]||0);
  const dispId = displaySerial(bc, ord);

  setText('ridView', dispId || 'â€”');
  setText('ridHint', d.branch ? `(${d.branch})` : '');
  document.getElementById('rMode').value = 'edit';
  document.getElementById('rSubmitBtn').textContent = 'ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„';
  document.getElementById('prevReceiptId').value = d.receiptId || "";

  fillPreview({
    receiptId: dispId,
    date:d.date, customer:d.customer, amount:d.amount, course:d.course,
    installment:d.installment, notes:d.notes, branch:d.branch, receiverName:d.receiverName
  });

  return {dispId};
}

/* ====== Ø¥ÙŠØµØ§Ù„Ø§Øª: Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙˆØ§Ù„Ø³ÙŠØ±ÙŠØ§Ù„ ÙˆØ§Ù„Ø·Ø¨Ø§Ø¹Ø© ====== */
function buildReceiptsEndpoint(branchVal,q){
  const p=new URLSearchParams(); p.set('searchReceipts','1'); p.set('q',q||''); if(branchVal) p.set('branch',branchVal);
  return url + "?" + p.toString();
}
async function searchReceipts(){
  const b=document.getElementById('recBranchFilter').value; 
  const q=document.getElementById('recQ').value.trim();
  await loadReceiptsTable(buildReceiptsEndpoint(b,q));
}
async function listAllReceipts(){
  const q=document.getElementById('recQ').value.trim(); 
  await loadReceiptsTable(buildReceiptsEndpoint('',q));
}
async function loadReceiptsTable(endpoint){
  const head=document.getElementById('recHead'); const body=document.getElementById('recBody');
  head.innerHTML=""; body.innerHTML="";
  if (!RECEIPT_ORDER_CACHE || !RECEIPT_ORDER_CACHE.map || RECEIPT_ORDER_CACHE.map.size===0){
    await buildReceiptOrderCache();
  }
  try{
    const d=await fetch(endpoint,{headers:{'Accept':'application/json'}}).then(r=>r.json());
    const rows=(d&&d.results)?d.results:[];
    head.innerHTML="<tr>"+["ID","Ø§Ù„ØªØ§Ø±ÙŠØ®","Ø§Ù„Ø§Ø³Ù…","Ø§Ù„Ù‚ÙŠÙ…Ø©","Ø§Ù„ÙƒÙˆØ±Ø³","Ø§Ù„Ø¯ÙØ¹Ø©","Ø§Ù„Ù…Ø³ØªÙ„Ù…","Ø§Ù„ÙØ±Ø¹","Ù…Ù„Ø§Ø­Ø¸Ø§Øª","ØªØ­ÙƒÙ…"].map(h=>`<th>${h}</th>`).join("")+"</tr>";
    if(!rows.length){ body.innerHTML="<tr><td class='muted'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬.</td></tr>"; return; }
    body.innerHTML=rows.map(r=>{
      const dispId = displaySerialForRow(r) || "";
      return `
      <tr>
        <td>${dispId}</td>
        <td>${r.date||""}</td>
        <td>${r.customer||""}</td>
        <td>${r.amount||""}</td>
        <td>${r.course||""}</td>
        <td>${r.installment||""}</td>
        <td>${r.receiverName||""}</td>
        <td>${r.branch||""}</td>
        <td>${r.notes||""}</td>
        <td>
          <button class="link" type="button" onclick='editReceipt(${JSON.stringify(r).replace(/'/g,"&#39;")})'>ØªØ¹Ø¯ÙŠÙ„</button>
          |
          <button class="link" type="button" onclick='previewAndPrint(${JSON.stringify(r).replace(/'/g,"&#39;")})'>Ø·Ø¨Ø§Ø¹Ø©</button>
        </td>
      </tr>`;
    }).join("");
  }catch{
    body.innerHTML="<tr><td>âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„</td></tr>";
  }
}

async function resetReceiptForm(){
  document.getElementById('receiptForm').reset();
  setVal('rStudentId',''); setVal('rCustomer','');
  const courseInput = document.getElementById('rCourse');
  courseInput.readOnly = false;
  courseInput.style.background = '';
  courseInput.value = '';
  setText('ridView','â€”'); setText('ridHint','');
  document.getElementById('rMode').value='create';
  document.getElementById('rSubmitBtn').textContent='ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¥ÙŠØµØ§Ù„';
  setVal('prevReceiptId','');
  setVal('rDate', await getOnlineNow());
}

async function submitReceipt(e){
  e.preventDefault();
  if(!document.getElementById('rStudentId').value){ alert('â— Ù„Ø§Ø²Ù… ØªØ®ØªØ§Ø± Ø·Ø§Ù„Ø¨ Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ Ø£ÙˆÙ„Ù‹Ø§.'); return; }
  const fd=new FormData();
  const mode=document.getElementById('rMode').value;
  if(mode==='edit'){ fd.append('action','updateReceipt'); fd.append('prevReceiptId',document.getElementById('prevReceiptId').value.trim()); }
  else { fd.append('formType','receipt'); }
  fd.append('branch',document.getElementById('rBranch').value.trim());
  const raw=document.getElementById('rDate').value; fd.append('date', raw? new Date(raw).toISOString() : "");
  fd.append('customer',document.getElementById('rCustomer').value.trim());
  fd.append('amount',document.getElementById('rAmount').value.trim());
  fd.append('course',document.getElementById('rCourse').value.trim());
  fd.append('installment',document.getElementById('rInstallment').value);
  fd.append('notes',document.getElementById('rNotes').value.trim());
  fd.append('receiverName', document.getElementById('rReceiver').value.trim());
  const msg=document.getElementById('rMsg'); msg.textContent= mode==='edit' ? 'â³ Ø¬Ø§Ø±Ù Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„...' : 'â³ Ø¬Ø§Ø±Ù Ø§Ù„Ø­ÙØ¸...';
  try{
    const d=await fetch(url,{method:'POST',body:fd}).then(r=>r.json());
    if(d&&d.result==='OK'){
      await buildReceiptOrderCache();
      const bc = String(d.branchCode||'').trim();
      const ord = RECEIPT_ORDER_CACHE.map.get(`${bc}|${d.serial}`) || (RECEIPT_ORDER_CACHE.counts[bc]||0);
      const dispId = displaySerial(bc, ord);

      setText('ridView', dispId || 'â€”'); setText('ridHint', d.branch ? `(${d.branch})` : '');
      msg.textContent= mode==='edit' ? 'âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„' : 'âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥ÙŠØµØ§Ù„';

      fillPreview({
        receiptId: dispId,
        date:d.date,customer:d.customer,amount:d.amount,course:d.course,
        installment:d.installment,notes:d.notes,branch:d.branch,receiverName: d.receiverName
      });

      const pv = document.getElementById('receiptPrint');
      pv.style.display='block';
      pv.scrollIntoView({behavior:'smooth',block:'nearest'});

      const lastBranch=document.getElementById('rBranch').value.trim();
      await resetReceiptForm(); 
      document.getElementById('rBranch').value=lastBranch;

      const b=document.getElementById('recBranchFilter').value; const q=document.getElementById('recQ').value.trim();
      await loadReceiptsTable(buildReceiptsEndpoint(b,q));
    } else if (d && d.code==='DUPLICATE_RID'){ msg.textContent='âŒ ID Ù…ÙØ³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„.'; }
    else { msg.textContent='âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸'; }
  }catch{ msg.textContent='âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„'; }
}

function fillPreview(src){
  const obj = src || {
    receiptId: (function(){ return document.getElementById('ridView').textContent.trim(); })(),
    date: (function(){ const v=document.getElementById('rDate').value; return v? v.replace('T',' ') : ''; })(),
    customer: document.getElementById('rCustomer').value.trim(),
    amount: document.getElementById('rAmount').value.trim(),
    course: document.getElementById('rCourse').value.trim(),
    installment: document.getElementById('rInstallment').value,
    notes: document.getElementById('rNotes').value.trim(),
    branch: document.getElementById('rBranch').value.trim(),
    receiverName: document.getElementById('rReceiver').value.trim()
  };
  const pv=document.getElementById('receiptPrint'); 
  pv.style.display='block';
  setText('pvReceiptId', obj.receiptId||""); 
  setText('pvDate', obj.date||""); 
  setText('pvCustomer', obj.customer||"");
  setText('pvAmount', obj.amount||""); 
  setText('pvCourse', obj.course||""); 
  setText('pvInstallment', obj.installment||"");
  setText('pvReceiver', obj.receiverName||"");
  setText('pvNotes', obj.notes||""); 
  setText('pvBranch', obj.branch||"");
}

/* ========= Ø·Ø¨Ø§Ø¹Ø© (Ù…Ø¹ Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙˆÙØ­Øµ Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª) ========= */
async function printReceipt(){
  if(!validateReceiptForm()) return;        // âœ… Ù…Ù†Ø¹ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø§ÙƒØªÙ…Ø§Ù„
  try{
    await saveReceiptIfNeeded();            // âœ… ÙŠØ­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù„Ùˆ Ù…Ø´ Ù…Ø­ÙÙˆØ¸
  }catch(e){
    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸ Ù‚Ø¨Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: ' + e.message);
    return;
  }

  if(document.getElementById('receiptPrint').style.display==='none'){ fillPreview(null); }
  const src = document.getElementById('receiptPrint');
  const makeCleanCopy = () => {
    const c = src.cloneNode(true);
    c.querySelectorAll('.no-print,button').forEach(el=>el.remove());
    return c;
  };
  const copy1 = makeCleanCopy();
  const copy2 = makeCleanCopy();

  const iframe = document.createElement('iframe');
  iframe.style.position='fixed';
  iframe.style.right='0'; iframe.style.bottom='0';
  iframe.style.width='0';  iframe.style.height='0';
  iframe.style.border='0';
  document.body.appendChild(iframe);

  const w = iframe.contentWindow;
  const doc = w.document;

  doc.open();
  doc.write(`<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    @page{ size:A4; margin:12mm; }
    html,body{ background:#fff; color:#000; margin:0; font-family:'Cairo',Arial,system-ui; }
    *{ box-sizing:border-box }
    .sheet{ display:flex; flex-direction:column; gap:22px; }
    .receipt-box{
      border:1.5px dashed #000; border-radius:12px; padding:16px; background:#fff;
      page-break-inside:avoid;
    }
    .print-head{ display:flex; align-items:center; gap:12px; }
    .print-head img{ height:60px; width:auto; object-fit:contain; }
    .print-head h3{ margin:0; flex:1; text-align:center; font-weight:700; }
    .kv2{ display:grid; grid-template-columns:160px 1fr 160px 1fr; gap:8px 12px; align-items:center; }
    @media print and (max-width:700px){
      .kv2{ grid-template-columns:140px 1fr; }
    }
    .signs{ display:flex; justify-content:space-between; margin:20px 0 40px 0; }
    .signs > div{ font-weight:700; color:#333; }
    .signs > div:first-child{ min-width:100px; text-align:right; }
    .signs > div:last-child{ flex:1; text-align:center; }
    .muted{ color:#475569; }
  </style>
</head>
<body>
  <div class="sheet" id="sheet"></div>
</body>
</html>`);
  doc.close();

  const wrap = doc.getElementById('sheet');
  const box1 = doc.createElement('div'); box1.className = 'receipt-box'; box1.appendChild(copy1);
  const box2 = doc.createElement('div'); box2.className = 'receipt-box'; box2.appendChild(copy2);
  wrap.appendChild(box1);
  wrap.appendChild(box2);

  const doPrint = () => { try{ w.focus(); }catch(_){} w.print(); setTimeout(()=>iframe.remove(), 800); };
  if (doc.fonts && doc.fonts.ready) { doc.fonts.ready.then(doPrint); } else { setTimeout(doPrint, 400); }
}

async function downloadPDF(){
  if(document.getElementById('receiptPrint').style.display==='none'){ fillPreview(null); }
  const el=document.getElementById('receiptPrint');
  const canvas=await html2canvas(el,{scale:2});
  const img=canvas.toDataURL('image/png');
  const {jsPDF}=window.jspdf; const pdf=new jsPDF('p','pt','a5');
  const w=pdf.internal.pageSize.getWidth(), pad=24, iw=w-pad*2, ih=canvas.height*(iw/canvas.width);
  pdf.addImage(img,'PNG',pad,pad,iw,ih);
  const rid=(document.getElementById('pvReceiptId').textContent||'receipt').replace(/[^\dA-Za-z_-]+/g,'_');
  pdf.save(`${rid}.pdf`);
}

async function editReceipt(r){
  openTab('panel-receipts');

  if (!RECEIPT_ORDER_CACHE || !RECEIPT_ORDER_CACHE.map || RECEIPT_ORDER_CACHE.map.size===0){
    await buildReceiptOrderCache();
  }

  setVal('rBranch', r.branch||"");
  setVal('rCustomer', r.customer||""); setVal('rStudentId','X');
  setVal('rCourse', r.course||""); 
  const courseInput = document.getElementById('rCourse');
  courseInput.readOnly = false;
  courseInput.style.background = '';

  setVal('rAmount', r.amount||""); setVal('rInstallment', r.installment||"1");
  setVal('rNotes', r.notes||"");
  setVal('rReceiver', r.receiverName || "");
  if (r.date){ const t=r.date.replace(' ','T'); setVal('rDate', t.length===16?t:t.substring(0,16)); }

  const dispId = displaySerialForRow(r) || "";
  setText('ridView', dispId || "â€”"); setText('ridHint', r.branch? `(${r.branch})` : '');

  document.getElementById('rMode').value='edit';
  document.getElementById('rSubmitBtn').textContent='ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„';
  document.getElementById('prevReceiptId').value = r.receiptId || "";

  fillPreview({
    receiptId: dispId,
    date:r.date||"",customer:r.customer||"",amount:r.amount||"",course:r.course||"",
    installment:r.installment||"",notes:r.notes||"",branch:r.branch||"",
    receiverName: r.receiverName || ""
  });
}
function previewAndPrint(r){ editReceipt(r); printReceipt(); }
</script>
</body>
</html>
