<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>لوحة الأكاديمية — الرئيسية / الطلاب / الإيصالات</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --brand:#17974b;--ink:#0b1324;--muted:#475569;--line:#e9eef5;--card:#fff;--bg:#f7f9fb;
    /* إعدادات الواجهة */
    --ui-zoom:1;          /* 1 = 100% ، 0.75 = 75% */
    --icon-zoom:1;        /* 1 عادي، 0.9 صغير، 1.1 كبير */
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:#000;font-family:'Cairo',system-ui,Segoe UI,Roboto,Arial}
  body{visibility:hidden; transform-origin: top center; }
  body.ready{visibility:visible}
  /* التكبير/التصغير العام للواجهة */
  body{ transform: scale(var(--ui-zoom)); }
  /* لمنع تصغير العرض الفعلي عند التصغير، نُعطي wrapper عرض منطقي */
  .page-wrap{ width: min(1280px, 100vw); margin: 0 auto; }

  .container{max-width:1200px;margin:auto;background:#fff;border:1px solid var(--line);border-radius:16px;padding:16px;margin-top:16px}
  h1,h2{color:var(--brand);margin:.2em 0 .6em}
  label{font-weight:700;display:block;margin:10px 0 6px}
  input,select,textarea,button{font-family:inherit}
  input,select,textarea{width:100%;padding:11px 12px;border:1px solid var(--line);border-radius:10px;font-size:15px;outline:none;background:#fff;color:#000}
  select option{color:#000}
  input:focus,select:focus,textarea:focus{border-color:#b7e2c8;box-shadow:0 0 0 3px rgba(23,151,75,.12)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:1024px){.row{grid-template-columns:1fr}}
  .row-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  @media (max-width:1024px){.row-3{grid-template-columns:1fr}}
  button{padding:12px 18px;background:var(--brand);color:#fff;border:none;border-radius:10px;cursor:pointer;font-weight:700}
  .btn-secondary{background:#0a6dd0}
  .btn-ghost{background:#eef4ff;color:#0a6dd0}
  .muted{color:var(--muted);font-size:14px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:16px auto 8px}
  .tab{padding:10px 14px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer;font-weight:700;color:#000}
  .tab.active{background:#eafff1;border-color:#cdebd8;color:#0b6b3d}
  .panel{display:none}
  .panel.active{display:block}
  .card{background:#f6fff9;border:1.5px solid #cfeedd;padding:14px;border-radius:12px;margin:10px 0}
  .table-wrap{width:100%;overflow:auto;border:1px solid var(--line);border-radius:12px;background:#fff}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--line);padding:9px 8px;text-align:right;font-size:14px;white-space:nowrap;color:#000}
  th{background:#f9fcff;position:sticky;top:0;z-index:1}

  /* Login modal */
  #loginModal{position:fixed;inset:0;background:#f0f2f5;display:flex;justify-content:center;align-items:center;z-index:99999}
  #loginModal .box{background:#fff;padding:28px;border-radius:14px;box-shadow:0 8px 30px rgba(0,0,0,.1);text-align:center;width:min(92vw,420px)}
  #loginModal input{padding:12px;font-size:16px;margin-top:12px;width:100%;border-radius:10px;border:1px solid var(--line)}

  /* Receipts picker */
  .picker-wrap{border:1px solid var(--line);border-radius:12px;padding:10px;background:#fff}
  .picker-toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
  #studentsPanel{display:block}
  #studentsSelect{width:100%;height:auto}

  /* Print preview block */
  #receiptPrint{display:none;margin-top:14px;border:1.5px dashed #bfe3cc;background:#fff;border-radius:12px;padding:16px}
  .print-head{display:flex;align-items:center;gap:12px}
  #receiptPrint .print-head img{height:60px;width:auto;object-fit:contain}
  #receiptPrint .print-head h3{margin:0;flex:1;text-align:center}

  .kv2{
    display:grid;
    grid-template-columns: 160px 1fr 160px 1fr;
    gap:8px 12px;
    align-items:center;
  }
  @media (max-width:700px){
    .kv2{ grid-template-columns: 140px 1fr; }
  }

  .signs{display:flex;justify-content:space-between;margin:20px 0 40px 0}
  .signs > div{font-weight:700;color:#333}
  .signs > div:first-child{min-width:100px;text-align:right}
  .signs > div:last-child{flex:1;text-align:center}

  /* طباعة عامة للصفحة (الطباعة الفعلية عبر iframe) */
  @media print{
    @page{ size:A4; margin:12mm; }
    .no-print{ display:none !important; }
  }

  /* هايلايت مؤقت للنموذج عند الدخول لوضع التعديل */
  .flash-focus{animation: flash 1.6s ease-out 1}
  @keyframes flash{
    0%{box-shadow:0 0 0 0 rgba(23,151,75,.45)}
    60%{box-shadow:0 0 0 6px rgba(23,151,75,.18)}
    100%{box-shadow:none}
  }

  /* ======== إعدادات الواجهة (تحكم الأيقونات) ======== */
  .ui-bar{display:flex;align-items:center;gap:8px;justify-content:space-between}
  .settings-btn{background:#fff;border:1px solid var(--line);border-radius:10px;padding:8px 12px;cursor:pointer}
  .settings-btn span{display:inline-block; transform: scale(var(--icon-zoom)); transform-origin:center;}
  .settings-panel{
    position:relative;
  }
  .settings-pop{
    position:absolute; inset-inline-end:0; top:42px; z-index:10;
    background:#fff; border:1px solid var(--line); border-radius:12px; padding:12px;
    min-width:260px; box-shadow:0 10px 24px rgba(0,0,0,.08);
    display:none;
  }
  .settings-pop.open{ display:block; }
  .settings-row{display:grid; grid-template-columns: 120px 1fr; gap:8px; align-items:center; margin:8px 0;}
  .settings-pop .muted{margin:8px 0 0; font-size:12px}

  /* ======== Overrides لضمان التدرّج مع التصغير ======== */
  /* نخلي العناصر ترث حجم الخط من الجسم بعد التصغير */
  input,select,textarea,button{ font-size:1em; }
  th,td{ font-size:.9em; }
  .tab, .btn-secondary, .btn-ghost, button{ font-size:1em; }
  /* تحكم حجم الأيقونات (الأزرار النصية) */
  .tabs .tab, button, .link{ transform: scale(var(--icon-zoom)); transform-origin:center; }
</style>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>
<body>
<div class="page-wrap">

<!-- شريط علوي فيه زر الإعدادات -->
<div class="container no-print">
  <div class="ui-bar">
    <div class="tabs" data-scope="main">
      <button class="tab active" data-panel="panel-home">🏠 الرئيسية</button>
      <button class="tab" data-panel="panel-students">🧑‍🎓 الطلاب</button>
      <button class="tab" data-panel="panel-receipts">🧾 الإيصالات</button>
    </div>

    <div class="settings-panel">
      <button class="settings-btn no-print" id="openSettings"><span>⚙️</span> الإعدادات</button>
      <div class="settings-pop" id="settingsPop">
        <div class="settings-row">
          <label>حجم الواجهة</label>
          <select id="uiZoomSelect">
            <option value="1">100%</option>
            <option value="0.9">90%</option>
            <option value="0.85">85%</option>
            <option value="0.8">80%</option>
            <option value="0.75">75%</option>
          </select>
        </div>
        <div class="settings-row">
          <label>حجم الأيقونات</label>
          <select id="iconSizeSelect">
            <option value="0.9">صغير</option>
            <option value="1">عادي</option>
            <option value="1.1">كبير</option>
          </select>
        </div>
        <div class="toolbar" style="justify-content:flex-end;margin-top:6px">
          <button class="btn-secondary" id="saveUi">حفظ</button>
          <button class="btn-ghost" id="closeSettings">إغلاق</button>
        </div>
        <div class="muted">*كل جهاز يقدر يحفظ اعدادات خاصة بيه عشان محدش يجي على حد</div>
      </div>
    </div>
  </div>
</div>

<!-- شاشة الدخول -->
<div id="loginModal">
  <div class="box">
    <h2>🔐 تسجيل الدخول</h2>
    <p class="muted">أدخل كلمة المرور للمتابعة</p>
    <input type="password" id="passwordInput" placeholder="*****" autofocus />
    <div style="margin-top:14px"><button id="loginBtn" onclick="checkPassword()">دخول</button></div>
    <p id="loginError" style="color:#d10e0e;margin-top:10px;font-weight:700"></p>
  </div>
</div>

<!-- الرئيسية -->
<div id="panel-home" class="panel active" data-scope="main">
  <div class="container">
    <h2>لوحة الأكاديمية</h2>
    <div class="row">
      <div class="card">
        <h3>الطلاب</h3>
        <p class="muted">تسجيل طالب جديد، البحث والتعديل.</p>
        <button class="btn-secondary" onclick="openTab('panel-students')">فتح صفحة الطلاب</button>
      </div>
      <div class="card">
        <h3>الإيصالات</h3>
        <p class="muted">إنشاء إيصال، البحث، التعديل والطباعة.</p>
        <button class="btn-secondary" onclick="openTab('panel-receipts')">فتح صفحة الإيصالات</button>
      </div>
    </div>
  </div>
</div>

<!-- الطلاب -->
<div id="panel-students" class="panel" data-scope="main">
  <div class="container">
    <h2>🧑‍🎓 تسجيل / تعديل طالب</h2>

    <form id="studentForm" onsubmit="submitStudent(event)">
      <input type="hidden" id="sMode" value="create" />
      <input type="hidden" id="prevStudentId" value="" />

      <div class="row">
        <div>
          <label>الاسم</label>
          <input id="sName" required />
        </div>
        <div>
          <label>النوع</label>
          <select id="sGender">
            <option value="">— اختر —</option>
            <option value="ذكر">ذكر</option>
            <option value="أنثى">أنثى</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>الهاتف (11–15 رقم)</label>
          <input id="sPhone1" inputmode="numeric" pattern="\d{11,15}" title="من 12 إلى 15 رقم" required />
        </div>
        <div>
          <label>هاتف بديل</label>
          <input id="sPhone2" inputmode="numeric" pattern="\d{0,15}" title="أرقام فقط" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>العمر</label>
          <input id="sAge" inputmode="numeric" pattern="\d{1,2}" title="أرقام فقط" />
        </div>
        <div>
          <label>العنوان</label>
          <input id="sAddress" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>المرحلة / المستوى</label>
          <select id="sLevel">
            <option value="">— اختر المستوى —</option>
          </select>
        </div>
        <div>
          <label>المدرسة</label>
          <input id="sSchool" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>وظيفة الأب</label>
          <input id="sFjob" />
        </div>
        <div>
          <label>وظيفة الأم</label>
          <input id="sMjob" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>خبرات سابقة</label>
          <input id="sExp" />
        </div>
        <div>
          <label>الفرع</label>
          <select id="sBranch" required></select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>كود الطالب (اختياري للتعديل اليدوي)</label>
          <input id="sId" placeholder="سيبه فاضي وبيتعدل في حالة الضرورة" />
        </div>
        <div class="toolbar" style="align-items:flex-end">
          <button type="submit" id="sSubmit">💾 حفظ</button>
          <button type="button" class="btn-ghost" onclick="resetStudentForm()">مسح</button>
        </div>
      </div>

      <div id="sMsg" class="muted" style="margin-top:8px"></div>
    </form>

    <div class="card" style="margin-top:14px">
      <h3>بحث وعرض الطلاب</h3>
      <div class="toolbar" style="gap:8px">
        <select id="sBranchFilter" style="min-width:180px"></select>
        <input id="sQ" placeholder="بحث عام (اسم/ID/هاتف/فرع)" />
        <button class="link" onclick="searchStudents()">بحث عام</button>
        <button class="link" onclick="listStudentsByBranch()">عرض حسب الفرع</button>
      </div>
      <div class="table-wrap" style="margin-top:10px"><table>
        <thead id="sHead"></thead>
        <tbody id="sBody"></tbody>
      </table></div>
    </div>
  </div>
</div>

<!-- الإيصالات -->
<div id="panel-receipts" class="panel" data-scope="main">
  <div class="container">
    <h2>🧾 الإيصالات — إنشاء / تعديل / بحث</h2>

    <!-- اختيار الطالب -->
    <div class="card">
      <label>اختيار الطالب</label>

      <div class="picker-wrap">
        <div class="picker-toolbar">
          <button type="button" class="btn-secondary" id="btnToggleStudents">قائمة الطلاب ⬇️</button>
          <input id="studentsFilter" placeholder="اكتب لتصفية الأسماء / الأكواد — Enter لاختيار أول نتيجة" style="flex:1" />
          <button type="button" class="btn-ghost" id="btnClearPick">مسح الاختيار</button>
        </div>

        <div id="studentsPanel">
          <select id="studentsSelect" size="8"></select>
        </div>
      </div>

      <small class="muted" id="studentsDiag"></small>
    </div>

    <form id="receiptForm" onsubmit="submitReceipt(event)">
      <input type="hidden" id="rMode" value="create" />
      <input type="hidden" id="prevReceiptId" value="" />
      <input type="hidden" id="rStudentId" value="" />

      <div class="row">
        <div>
          <label>الفرع</label>
          <select id="rBranch" required></select>
        </div>
        <div>
          <label>تاريخ الإيصال</label>
          <input id="rDate" type="datetime-local" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>اسم الطالب</label>
          <input id="rCustomer" readonly placeholder="يُملأ تلقائيًا بعد الاختيار" />
        </div>
        <div>
          <label>الكورس</label>
          <input id="rCourse" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>القيمة</label>
          <input id="rAmount" inputmode="numeric" pattern="\d+(\.\d{1,2})?" title="رقم فقط" required />
        </div>
        <div>
          <label>الدفعة</label>
          <select id="rInstallment" required>
            <option value="1">1</option><option value="2">2</option><option value="3">3</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>اسم المستلم</label>
          <input id="rReceiver" placeholder="مثال: أ/ محمد علي" />
        </div>
        <div>
          <label>ملاحظات</label>
          <input id="rNotes" />
        </div>
      </div>

      <div class="card">
        <div class="toolbar">
          <span class="muted">ID الإيصال (عرض):</span>
          <strong id="ridView">—</strong>
          <span class="muted" id="ridHint"></span>
        </div>
      </div>

      <div class="toolbar" style="margin-top:10px">
        <button type="submit" id="rSubmitBtn">💾 حفظ الإيصال</button>
        <button class="btn-secondary" type="button" onclick="printReceipt()">🖨️ طباعة</button>
        <button class="link" type="button" onclick="downloadPDF()">⬇️ تنزيل PDF</button>
        <button class="link" type="button" onclick="resetReceiptForm()">مسح</button>
      </div>
      <div id="rMsg" class="muted" style="margin-top:8px"></div>
    </form>

    <div class="card" style="margin-top:14px">
      <div class="toolbar" style="gap:8px">
        <select id="recBranchFilter" style="min-width:180px"></select>
        <input id="recQ" placeholder="بحث (اسم/ID/فرع/مبلغ/كورس/دفعة/مستلم)" />
        <button class="link" onclick="searchReceipts()">بحث</button>
        <button class="link" onclick="listAllReceipts()">عرض الكل</button>
      </div>
      <div class="table-wrap" style="margin-top:10px"><table>
        <thead id="recHead"></thead>
        <tbody id="recBody"></tbody>
      </table></div>
    </div>

    <div id="receiptPrint">
      <div class="print-head" style="display:flex;align-items:center;justify-content:space-between;flex-direction:row-reverse;">
        <img src="logo.png" alt="Logo" style="height:30px;object-fit:contain;">
        <h3 style="margin:0;flex:1;text-align:center;">إيصال دفع</h3>
        <button type="button" class="btn-secondary no-print" onclick="printReceipt()">🖨️ طباعة</button>
      </div>
      <div class="kv2">
        <div class="k">رقم الإيصال:</div><div class="v" id="pvReceiptId"></div>
        <div class="k">التاريخ:</div><div class="v" id="pvDate"></div>
        <div class="k">اسم العميل:</div><div class="v" id="pvCustomer"></div>
        <div class="k">القيمة:</div><div class="v" id="pvAmount"></div>
        <div class="k">الكورس:</div><div class="v" id="pvCourse"></div>
        <div class="k">الدفعة:</div><div class="v" id="pvInstallment"></div>
        <div class="k">اسم المستلم:</div><div class="v" id="pvReceiver"></div>
        <div class="k">ملاحظات:</div><div class="v" id="pvNotes"></div>
        <div class="k">الفرع:</div><div class="v" id="pvBranch"></div>
      </div>
      <div class="signs">
        <div>الختم</div>
        <div>التوقيع</div>
      </div>
    </div>
  </div>
</div>

</div><!-- /page-wrap -->

<script>
/* ================= إعدادات أساسية ================= */
const url = "https://script.google.com/macros/s/AKfycbxHOvORBDx8Jz7Dhi0uFV42h3OUbYdWNVZVZ-gsVO5o85CUrN6NiqwcllPN-knMTsM5/exec";

/* ================= تخزين الواجهة (LocalStorage) ================= */
const UI_STORAGE_KEY = "academy_ui_settings_v1";
function loadUiSettings(){
  try{
    const raw = localStorage.getItem(UI_STORAGE_KEY);
    if(!raw) return { uiZoom: "1", iconZoom: "1" };
    const parsed = JSON.parse(raw);
    return {
      uiZoom: String(parsed.uiZoom || "1"),
      iconZoom: String(parsed.iconZoom || "1")
    };
  }catch{ return { uiZoom:"1", iconZoom:"1" }; }
}
function applyUiSettings(s){
  document.documentElement.style.setProperty('--ui-zoom', s.uiZoom || "1");
  document.documentElement.style.setProperty('--icon-zoom', s.iconZoom || "1");
  const zSel = document.getElementById('uiZoomSelect');
  const iSel = document.getElementById('iconSizeSelect');
  if(zSel) zSel.value = s.uiZoom || "1";
  if(iSel) iSel.value = s.iconZoom || "1";
}
function saveUiSettings(){
  const uiZoom = document.getElementById('uiZoomSelect').value;
  const iconZoom = document.getElementById('iconSizeSelect').value;
  const s = { uiZoom, iconZoom };
  localStorage.setItem(UI_STORAGE_KEY, JSON.stringify(s));
  applyUiSettings(s);
}

/* ================= تسجيل الدخول ================= */
let realPassword = "";
function focusPassword(){ const i=document.getElementById('passwordInput'); if(i){i.focus(); i.select?.();} }
document.addEventListener('DOMContentLoaded', ()=>{
  focusPassword();
  // إعدادات الواجهة فور التحميل
  applyUiSettings(loadUiSettings());

  // فتح/إغلاق إعدادات الواجهة
  const btn = document.getElementById('openSettings');
  const box = document.getElementById('settingsPop');
  const close = document.getElementById('closeSettings');
  const save = document.getElementById('saveUi');
  btn?.addEventListener('click', ()=> box.classList.toggle('open'));
  close?.addEventListener('click', ()=> box.classList.remove('open'));
  save?.addEventListener('click', ()=>{ saveUiSettings(); box.classList.remove('open'); });
  // اغلاق عند الضغط خارج البوكس
  document.addEventListener('click', (e)=>{
    if(!box) return;
    const inside = box.contains(e.target) || btn.contains(e.target);
    if(!inside) box.classList.remove('open');
  });
});

fetch(url + "?getpass=1",{headers:{'Accept':'application/json'}}).then(r=>r.json()).then(d=>{
  realPassword = (d.password||"").toString().trim();
  document.body.classList.add('ready');
  focusPassword();
  initCommon();
}).catch(()=>{
  document.body.classList.add('ready');
  document.getElementById('loginError').textContent = "تعذّر الاتصال بالباسوورد من الشيت.";
});
function checkPassword(){
  const v=document.getElementById('passwordInput').value.trim();
  if(v===realPassword){ document.getElementById('loginModal').style.display='none'; }
  else { document.getElementById('loginError').textContent = "كلمة المرور غير صحيحة!"; }
}
document.getElementById('passwordInput').addEventListener('keydown', e=>{
  if(e.key==='Enter'){ e.preventDefault(); document.getElementById('loginBtn').click(); }
});

/* ================= تبويبات ================= */
function openTab(id){
  document.querySelectorAll('.tabs .tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.panel[data-scope="main"]').forEach(p=>p.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelector(`.tabs [data-panel="${id}"]`)?.classList.add('active');
  if(id==='panel-receipts'){ openStudentsPanel(); }
}
document.querySelectorAll('.tabs').forEach(group=>{
  const scope = group.dataset.scope;
  group.querySelectorAll('.tab').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      group.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
      btn.classList.add('active');
      const target = btn.dataset.panel;
      document.querySelectorAll(`.panel[data-scope="${scope}"]`).forEach(p=>p.classList.remove('active'));
      document.getElementById(target).classList.add('active');
      if(target==='panel-receipts'){ openStudentsPanel(); }
    });
  });
});

/* ================= Helpers ================= */
const setVal=(id,v)=>{ const el=document.getElementById(id); if(el) el.value=v??""; };
const setText=(id,v)=>{ const el=document.getElementById(id); if(el) el.textContent=v??""; };
async function getOnlineNow(){
  try{
    const r = await fetch('https://worldtimeapi.org/api/timezone/Africa/Cairo');
    const d = await r.json();
    return d.datetime.slice(0,16);
  }catch{
    const x=new Date(), p=v=>String(v).padStart(2,'0');
    return `${x.getFullYear()}-${p(x.getMonth()+1)}-${p(x.getDate())}T${p(x.getHours())}:${p(x.getMinutes())}`;
  }
}

/* ==== تطبيع النص العربي للبحث ==== */
function normalizeArabic(str){
  if(str==null) return "";
  let s = String(str);
  const arabicNums = {'٠':'0','١':'1','٢':'2','٣':'3','٤':'4','٥':'5','٦':'6','٧':'7','٨':'8','٩':'9'};
  const persianNums= {'۰':'0','۱':'1','۲':'2','۳':'3','۴':'4','۵':'5','۶':'6','۷':'7','۸':'8','۹':'9'};
  s = s.replace(/[٠-٩]/g, d=>arabicNums[d]).replace(/[۰-۹]/g, d=>persianNums[d]);
  s = s.replace(/[\u064B-\u065F\u0670]/g,'').replace(/\u0640/g,'');
  s = s.replace(/[أإآ]/g,'ا').replace(/ى/g,'ي').replace(/ة/g,'ه').replace(/ؤ/g,'و').replace(/ئ/g,'ي');
  return s.toLowerCase().trim().replace(/\s+/g,' ');
}
function toKey(student){
  const parts = [student.name||'', student.id||'', student.branch||'', student.schoolLevel||''];
  return normalizeArabic(parts.join(' '));
}

/* ====== عرض Serial مخصص ====== */
let RECEIPT_ORDER_CACHE = { map:new Map(), counts:{} };
async function buildReceiptOrderCache(){
  try{
    const d = await fetch(url + "?searchReceipts=1&q=",{headers:{'Accept':'application/json'}}).then(r=>r.json());
    const rows = (d&&d.results) ? d.results.slice() : [];
    rows.sort((a,b)=>(parseInt(a.serial||0)-parseInt(b.serial||0)));
    const by = {};
    rows.forEach(r=>{
      const bc = String(r.branchCode||'').trim();
      if(!by[bc]) by[bc]=[];
      by[bc].push(r);
    });
    const map = new Map();
    const counts = {};
    Object.entries(by).forEach(([bc,list])=>{
      counts[bc] = list.length;
      list.forEach((r,idx)=> map.set(`${bc}|${r.serial}`, idx+1));
    });
    RECEIPT_ORDER_CACHE = { map, counts };
  }catch{
    RECEIPT_ORDER_CACHE = { map:new Map(), counts:{} };
  }
}
function displaySerial(branchCode, ordinal){
  const bc = String(parseInt(branchCode||0,10)).padStart(2,'0'); // ✅ رقمين
  const n  = parseInt(ordinal||0,10);
  if(!bc || isNaN(n) || n<=0) return "";
  return bc + String(n).padStart(6,'0');
}
function displaySerialForRow(r){
  const bc = String(r.branchCode||'').trim();
  const ord = RECEIPT_ORDER_CACHE.map.get(`${bc}|${r.serial}`) || 0;
  return displaySerial(bc, ord);
}

/* ================= مشتركة ================= */
async function loadBranchesTo(selectId){
  try{
    const data = await fetch(url + "?listBranches=1",{headers:{'Accept':'application/json'}}).then(r=>r.json());
    const arr = (data && data.results) ? data.results : [{name:'مصر الجديدة'},{name:'شبرا مصر'}];
    const sel = document.getElementById(selectId);
    if (!sel) return;
    sel.innerHTML = `<option value="" ${selectId!=='recBranchFilter'?'disabled selected':''}>${selectId!=='recBranchFilter'?'— اختر الفرع —':'كل الفروع'}</option>` +
      arr.map(b=>`<option value="${b.name}">${b.name}</option>`).join('');
  }catch{
    const sel = document.getElementById(selectId);
    if (!sel) return;
    sel.innerHTML = `<option value="" ${selectId!=='recBranchFilter'?'disabled selected':''}>${selectId!=='recBranchFilter'?'— اختر الفرع —':'كل الفروع'}</option>` +
      `<option value="مصر الجديدة">مصر الجديدة</option><option value="شبرا مصر">شبرا مصر</option>`;
  }
}
async function loadLevelsTo(selectId){
  try{
    const data = await fetch(url + "?listLevels=1",{headers:{'Accept':'application/json'}}).then(r=>r.json());
    const arr = (data && data.results && data.results.length) ? data.results : ["Level 1","Level 2","Level 3","Level 4"];
    const sel = document.getElementById(selectId);
    if(!sel) return;
    sel.innerHTML = `<option value="">— اختر المستوى —</option>` + arr.map(v=>`<option value="${v}">${v}</option>`).join('');
  }catch{
    const sel = document.getElementById(selectId);
    if(!sel) return;
    sel.innerHTML = `<option value="">— اختر المستوى —</option>
      <option>Level 1</option><option>Level 2</option><option>Level 3</option><option>Level 4</option>`;
  }
}
async function initCommon(){
  await loadBranchesTo('sBranch');
  await loadBranchesTo('sBranchFilter');
  await loadLevelsTo('sLevel');
  await loadBranchesTo('rBranch');
  await loadBranchesTo('recBranchFilter');
  setVal('rDate', await getOnlineNow());
  initStudentsPage();
  await initReceiptsPage();
}

/* ==================== الطلاب ==================== */
function resetStudentForm(){
  document.getElementById('studentForm').reset();
  document.getElementById('sMode').value='create';
  document.getElementById('sSubmit').textContent='💾 حفظ';
  setVal('prevStudentId','');
  document.getElementById('sMsg').textContent='';
}
async function submitStudent(e){
  e.preventDefault();
  const mode = document.getElementById('sMode').value;
  const fd = new FormData();
  if (mode==='edit'){ fd.append('action','updateStudent'); fd.append('prevId', document.getElementById('prevStudentId').value.trim()); }
  else { fd.append('formType','student'); }
  fd.append('name', document.getElementById('sName').value.trim());
  fd.append('gender', document.getElementById('sGender').value.trim());
  fd.append('primaryPhone', document.getElementById('sPhone1').value.trim());
  fd.append('altPhone', document.getElementById('sPhone2').value.trim());
  fd.append('age', document.getElementById('sAge').value.trim());
  fd.append('address', document.getElementById('sAddress').value.trim());
  fd.append('schoolLevel', document.getElementById('sLevel').value.trim());
  fd.append('schoolName', document.getElementById('sSchool').value.trim());
  fd.append('fatherJob', document.getElementById('sFjob').value.trim());
  fd.append('motherJob', document.getElementById('sMjob').value.trim());
  fd.append('previousExperience', document.getElementById('sExp').value.trim());
  fd.append('branch', document.getElementById('sBranch').value.trim());
  const manualId = document.getElementById('sId').value.trim();
  if (manualId) fd.append('studentId', manualId);
  const msg = document.getElementById('sMsg');
  msg.textContent = mode==='edit' ? '⏳ جارٍ حفظ التعديل...' : '⏳ جارٍ الحفظ...';
  try{
    const d = await fetch(url,{method:'POST',body:fd}).then(r=>r.json());
    if (d && d.result==='OK'){
      const newId = d.id || document.getElementById('sId').value.trim() || '';
      msg.textContent = mode==='edit' ? '✅ تم حفظ التعديل' : `🆕 تم التسجيل — ID: ${newId}`;
      if(newId){ setVal('sQ', newId); await searchStudents(); } else { await searchStudents(); }
      if (mode!=='edit') {
        const keepBranch = document.getElementById('sBranch').value;
        resetStudentForm();
        document.getElementById('sBranch').value = keepBranch;
      } else {
        document.getElementById('panel-students').scrollIntoView({behavior:'smooth', block:'start'});
        document.getElementById('sName').classList.add('flash-focus');
        document.getElementById('sGender').classList.add('flash-focus');
        setTimeout(()=>{
          document.getElementById('sName').classList.remove('flash-focus');
          document.getElementById('sGender').classList.remove('flash-focus');
        },1700);
      }
    } else if (d && d.code==='DUPLICATE_ID'){
      msg.textContent = '❌ هذا الكود مستخدم مسبقًا';
    } else { msg.textContent = '❌ حدث خطأ في الحفظ'; }
  }catch{ msg.textContent = '❌ خطأ في الاتصال'; }
}
function initStudentsPage(){
  document.getElementById('sPhone1').addEventListener('input', e=> e.target.value=e.target.value.replace(/\D/g,''));
  document.getElementById('sPhone2').addEventListener('input', e=> e.target.value=e.target.value.replace(/\D/g,''));
}
function searchStudents(){
  const q = document.getElementById('sQ').value.trim();
  return fetch(url + "?searchStudents=1&q=" + encodeURIComponent(q))
    .then(r=>r.json()).then(data=>{
      const rows = (data && data.results) ? data.results : [];
      renderStudentsTable(rows);
    }).catch(()=> renderStudentsTable([]));
}
function listStudentsByBranch(){
  const b = document.getElementById('sBranchFilter').value;
  const ep = url + "?listStudentsByBranch=1" + (b? "&branch=" + encodeURIComponent(b) : "");
  fetch(ep).then(r=>r.json()).then(d=>{
    const rows = (d && d.results) ? d.results : [];
    renderStudentsTable(rows);
  }).catch(()=> renderStudentsTable([]));
}
function renderStudentsTable(rows){
  const head=document.getElementById('sHead'), body=document.getElementById('sBody');
  head.innerHTML = "<tr>" + ["ID","الاسم","الهاتف","الفرع","المستوى","التاريخ","تحكم"].map(h=>`<th>${h}</th>`).join("") + "</tr>";
  if (!rows.length){ body.innerHTML = "<tr><td class='muted'>لا توجد نتائج.</td></tr>"; return; }
  body.innerHTML = rows.map(r=>`
    <tr>
      <td>${r.id||""}</td>
      <td>${r.name||""}</td>
      <td>${r.primaryPhone||""}</td>
      <td>${r.branch||""}</td>
      <td>${r.schoolLevel||""}</td>
      <td>${r.date||""}</td>
      <td><button class="link" type="button" onclick='editStudent(${JSON.stringify(r).replace(/'/g,"&#39;")})'>تعديل</button></td>
    </tr>
  `).join("");
}
function editStudent(s){
  openTab('panel-students');
  setVal('sName', s.name||"");
  setVal('sGender', s.gender||"");
  setVal('sPhone1', s.primaryPhone||"");
  setVal('sPhone2', s.altPhone||"");
  setVal('sAge', s.age||"");
  setVal('sAddress', s.address||"");
  setVal('sLevel', s.schoolLevel||"");
  setVal('sSchool', s.schoolName||"");
  setVal('sFjob', s.fatherJob||"");
  setVal('sMjob', s.motherJob||"");
  setVal('sExp', s.previousExperience||"");
  setVal('sBranch', s.branch||"");
  setVal('sId', s.id||"");
  document.getElementById('sMode').value='edit';
  document.getElementById('sSubmit').textContent='💾 حفظ التعديل';
  setVal('prevStudentId', s.id||"");
  document.getElementById('sMsg').textContent = `تحرير: ${s.name||''}`;
  document.getElementById('panel-students').scrollIntoView({behavior:'smooth', block:'start'});
  document.getElementById('sName').classList.add('flash-focus');
  document.getElementById('sGender').classList.add('flash-focus');
  setTimeout(()=>{
    document.getElementById('sName').classList.remove('flash-focus');
    document.getElementById('sGender').classList.remove('flash-focus');
  },1700);
}

/* ==================== الإيصالات ==================== */
let STUDENTS_CACHE = [];
let TOTAL_STUDENTS = 0;

// type-ahead
let selectTypeBuffer = "";
let lastTypeTime = 0;

async function initReceiptsPage(){
  document.getElementById('rBranch').addEventListener('change', async ()=>{
    setVal('rDate', await getOnlineNow());
  });
  setVal('rDate', await getOnlineNow());
  document.getElementById('rAmount').addEventListener('input', e=> e.target.value=e.target.value.replace(/[^0-9.]/g,''));

  await preloadStudents();
  bindStudentsPicker();

  await buildReceiptOrderCache();

  openStudentsPanel();
  listAllReceipts();
}

async function preloadStudents(){
  const diag = document.getElementById('studentsDiag');
  diag.textContent = "⏳ جارٍ تحميل قائمة الطلاب...";
  try{
    const r = await fetch(url + "?listStudentsBasic=1",{headers:{'Accept':'application/json'}});
    const d = await r.json();
    const arr = (d && d.results) ? d.results : [];
    STUDENTS_CACHE = Array.isArray(arr)
      ? arr.filter(x=>x && (x.name||x.id)).map(s=>({ ...s, _key: toKey(s) }))
      : [];
    TOTAL_STUDENTS = STUDENTS_CACHE.length;
    diag.textContent = `✅ تم تحميل ${TOTAL_STUDENTS} طالب/طالبة.`;
  }catch(e){
    STUDENTS_CACHE = [];
    TOTAL_STUDENTS = 0;
    diag.textContent = "⚠️ لم أستطع تحميل الأسماء.";
  }
}
function updateStudentsCount(current){
  const diag = document.getElementById('studentsDiag');
  if (TOTAL_STUDENTS===0) return;
  diag.textContent = `النتائج: ${current} من ${TOTAL_STUDENTS} — اضغط Enter لاختيار أول نتيجة`;
}
function fillStudentsSelect(list){
  const sel = document.getElementById('studentsSelect');
  sel.innerHTML = '';
  if (!list || !list.length){
    const opt = document.createElement('option');
    opt.disabled = true;
    opt.textContent = 'لا توجد نتائج مطابقة';
    sel.appendChild(opt);
    updateStudentsCount(0);
    return;
  }
  list.forEach(st=>{
    const opt = document.createElement('option');
    opt.value = st.id || '';
    opt.textContent = `${st.name||''} — ${st.id||''} (${st.branch||''})`;
    opt.dataset.branch = st.branch||'';
    opt.dataset.level  = st.schoolLevel||'';
    opt.dataset.name   = st.name||'';
    opt.dataset.key    = st._key||'';
    sel.appendChild(opt);
  });
  sel.selectedIndex = 0;
  updateStudentsCount(list.length);
}
function localFilterStudents(q){
  const nq = normalizeArabic(q||'');
  if (!nq) return STUDENTS_CACHE.slice();
  const tokens = nq.split(' ').filter(Boolean);
  return STUDENTS_CACHE.filter(s => tokens.every(t => s._key.includes(t)));
}
function applyFilterAndRender(q){
  const list = localFilterStudents(q);
  fillStudentsSelect(list);
  return list;
}
function pickFromOption(opt){
  if (!opt || opt.disabled) return;
  const id    = opt.value || '';
  const name  = opt.dataset.name || '';
  const branch= opt.dataset.branch || '';
  const level = opt.dataset.level || '';
  setVal('rStudentId', id);
  setVal('rCustomer', name);
  if (branch) document.getElementById('rBranch').value = branch;

  const courseInput = document.getElementById('rCourse');
  courseInput.value = level || '';
  courseInput.readOnly = true;
  courseInput.style.background = '#f8fafc';

  fillPreview(null);
}
function bindStudentsPicker(){
  const btnToggle = document.getElementById('btnToggleStudents');
  const panel     = document.getElementById('studentsPanel');
  const sel       = document.getElementById('studentsSelect');
  const filter    = document.getElementById('studentsFilter');
  const clearBtn  = document.getElementById('btnClearPick');

  fillStudentsSelect(STUDENTS_CACHE);

  btnToggle.addEventListener('click', ()=>{
    panel.style.display = (panel.style.display==='none' || !panel.style.display) ? 'block' : 'none';
    if (panel.style.display==='block'){ filter.focus(); }
  });

  let t=null;
  filter.addEventListener('input', e=>{
    clearTimeout(t);
    const q=e.target.value;
    t=setTimeout(()=> applyFilterAndRender(q), 60);
  });

  filter.addEventListener('keydown', e=>{
    if (e.key === 'ArrowDown'){
      e.preventDefault();
      if (sel.options.length>0){ sel.focus(); sel.selectedIndex = Math.max(sel.selectedIndex, 0); }
    }
    if (e.key === 'Enter'){
      e.preventDefault();
      if (sel.options.length===0){ alert('لا توجد نتائج مطابقة.'); return; }
      const opt = sel.options[sel.selectedIndex >= 0 ? sel.selectedIndex : 0];
      pickFromOption(opt);
    }
  });

  sel.addEventListener('change', ()=>{
    const opt = sel.selectedOptions[0];
    pickFromOption(opt);
  });

  sel.addEventListener('keydown', (e)=>{
    const now = Date.now();
    if (now - lastTypeTime > 800) selectTypeBuffer = "";
    lastTypeTime = now;

    if (/^[\w\u0600-\u06FF\s]$/.test(e.key) && !e.ctrlKey && !e.metaKey && !e.altKey){
      selectTypeBuffer += e.key;
      const look = normalizeArabic(selectTypeBuffer);
      const opts = Array.from(sel.options);
      const idx = opts.findIndex(o => (o.dataset.key||normalizeArabic(o.textContent||'')).includes(look));
      if (idx >= 0){ sel.selectedIndex = idx; }
    }

    if (e.key === 'Enter'){
      e.preventDefault();
      const opt = sel.selectedOptions[0];
      pickFromOption(opt);
    }
  });

  sel.addEventListener('dblclick', ()=>{
    const opt = sel.selectedOptions[0];
    pickFromOption(opt);
  });

  clearBtn.addEventListener('click', ()=>{
    setVal('studentsFilter','');
    fillStudentsSelect(STUDENTS_CACHE);
    setVal('rStudentId',''); setVal('rCustomer','');
    const courseInput = document.getElementById('rCourse');
    courseInput.readOnly = false;
    courseInput.style.background = '';
    courseInput.value = '';
    sel.selectedIndex = -1;
    filter.focus();
  });
}
function openStudentsPanel(){
  const panel  = document.getElementById('studentsPanel');
  const filter = document.getElementById('studentsFilter');
  panel.style.display='block';
  filter.focus();
}

/* ====== فحص اكتمال بيانات الإيصال قبل الطباعة ====== */
function validateReceiptForm(){
  const branch = document.getElementById('rBranch').value.trim();
  const date   = document.getElementById('rDate').value.trim();
  const sid    = document.getElementById('rStudentId').value.trim();
  const name   = document.getElementById('rCustomer').value.trim();
  const amount = document.getElementById('rAmount').value.trim();
  const course = document.getElementById('rCourse').value.trim();
  const inst   = document.getElementById('rInstallment').value.trim();
  const recv   = document.getElementById('rReceiver').value.trim();

  const errs = [];
  if(!branch) errs.push('الفرع');
  if(!date)   errs.push('التاريخ');
  if(!sid || !name) errs.push('اسم الطالب (اختيار من القائمة)');
  if(!amount || !/^\d+(\.\d{1,2})?$/.test(amount)) errs.push('القيمة (رقم صحيح)');
  if(!course) errs.push('الكورس');
  if(!inst)   errs.push('الدفعة');
  if(!recv)   errs.push('اسم المستلم');

  if (errs.length){
    alert('لا يمكن الطباعة قبل اكتمال البيانات:\n- ' + errs.join('\n- '));
    return false;
  }
  return true;
}

/* ====== حفظ تلقائي قبل الطباعة (إنشاء/تعديل) ====== */
async function saveReceiptIfNeeded(){
  const mode = document.getElementById('rMode').value;
  const fd = new FormData();
  if(mode==='edit'){
    fd.append('action','updateReceipt');
    fd.append('prevReceiptId', document.getElementById('prevReceiptId').value.trim());
  } else {
    fd.append('formType','receipt');
  }
  fd.append('branch', document.getElementById('rBranch').value.trim());
  const raw = document.getElementById('rDate').value;
  fd.append('date', raw? new Date(raw).toISOString() : "");
  fd.append('customer', document.getElementById('rCustomer').value.trim());
  fd.append('amount', document.getElementById('rAmount').value.trim());
  fd.append('course', document.getElementById('rCourse').value.trim());
  fd.append('installment', document.getElementById('rInstallment').value);
  fd.append('notes', document.getElementById('rNotes').value.trim());
  fd.append('receiverName', document.getElementById('rReceiver').value.trim());

  const d = await fetch(url, {method:'POST', body:fd}).then(r=>r.json());
  if(!(d && d.result==='OK')) throw new Error('تعذّر الحفظ التلقائي قبل الطباعة');

  await buildReceiptOrderCache();
  const bc = String(d.branchCode||'').trim();
  const ord = RECEIPT_ORDER_CACHE.map.get(`${bc}|${d.serial}`) || (RECEIPT_ORDER_CACHE.counts[bc]||0);
  const dispId = displaySerial(bc, ord);

  setText('ridView', dispId || '—');
  setText('ridHint', d.branch ? `(${d.branch})` : '');
  document.getElementById('rMode').value = 'edit';
  document.getElementById('rSubmitBtn').textContent = '💾 حفظ التعديل';
  document.getElementById('prevReceiptId').value = d.receiptId || "";

  fillPreview({
    receiptId: dispId,
    date:d.date, customer:d.customer, amount:d.amount, course:d.course,
    installment:d.installment, notes:d.notes, branch:d.branch, receiverName:d.receiverName
  });

  return {dispId};
}

/* ====== إيصالات: الجدول والسيريال والطباعة ====== */
function buildReceiptsEndpoint(branchVal,q){
  const p=new URLSearchParams(); p.set('searchReceipts','1'); p.set('q',q||''); if(branchVal) p.set('branch',branchVal);
  return url + "?" + p.toString();
}
async function searchReceipts(){
  const b=document.getElementById('recBranchFilter').value; 
  const q=document.getElementById('recQ').value.trim();
  await loadReceiptsTable(buildReceiptsEndpoint(b,q));
}
async function listAllReceipts(){
  const q=document.getElementById('recQ').value.trim(); 
  await loadReceiptsTable(buildReceiptsEndpoint('',q));
}
async function loadReceiptsTable(endpoint){
  const head=document.getElementById('recHead'); const body=document.getElementById('recBody');
  head.innerHTML=""; body.innerHTML="";
  if (!RECEIPT_ORDER_CACHE || !RECEIPT_ORDER_CACHE.map || RECEIPT_ORDER_CACHE.map.size===0){
    await buildReceiptOrderCache();
  }
  try{
    const d=await fetch(endpoint,{headers:{'Accept':'application/json'}}).then(r=>r.json());
    const rows=(d&&d.results)?d.results:[];
    head.innerHTML="<tr>"+["ID","التاريخ","الاسم","القيمة","الكورس","الدفعة","المستلم","الفرع","ملاحظات","تحكم"].map(h=>`<th>${h}</th>`).join("")+"</tr>";
    if(!rows.length){ body.innerHTML="<tr><td class='muted'>لا توجد نتائج.</td></tr>"; return; }
    body.innerHTML=rows.map(r=>{
      const dispId = displaySerialForRow(r) || "";
      return `
      <tr>
        <td>${dispId}</td>
        <td>${r.date||""}</td>
        <td>${r.customer||""}</td>
        <td>${r.amount||""}</td>
        <td>${r.course||""}</td>
        <td>${r.installment||""}</td>
        <td>${r.receiverName||""}</td>
        <td>${r.branch||""}</td>
        <td>${r.notes||""}</td>
        <td>
          <button class="link" type="button" onclick='editReceipt(${JSON.stringify(r).replace(/'/g,"&#39;")})'>تعديل</button>
          |
          <button class="link" type="button" onclick='previewAndPrint(${JSON.stringify(r).replace(/'/g,"&#39;")})'>طباعة</button>
        </td>
      </tr>`;
    }).join("");
  }catch{
    body.innerHTML="<tr><td>❌ خطأ في الاتصال</td></tr>";
  }
}

async function resetReceiptForm(){
  document.getElementById('receiptForm').reset();
  setVal('rStudentId',''); setVal('rCustomer','');
  const courseInput = document.getElementById('rCourse');
  courseInput.readOnly = false;
  courseInput.style.background = '';
  courseInput.value = '';
  setText('ridView','—'); setText('ridHint','');
  document.getElementById('rMode').value='create';
  document.getElementById('rSubmitBtn').textContent='💾 حفظ الإيصال';
  setVal('prevReceiptId','');
  setVal('rDate', await getOnlineNow());
}

async function submitReceipt(e){
  e.preventDefault();
  if(!document.getElementById('rStudentId').value){ alert('❗ لازم تختار طالب من قائمة الطلاب أولًا.'); return; }
  const fd=new FormData();
  const mode=document.getElementById('rMode').value;
  if(mode==='edit'){ fd.append('action','updateReceipt'); fd.append('prevReceiptId',document.getElementById('prevReceiptId').value.trim()); }
  else { fd.append('formType','receipt'); }
  fd.append('branch',document.getElementById('rBranch').value.trim());
  const raw=document.getElementById('rDate').value; fd.append('date', raw? new Date(raw).toISOString() : "");
  fd.append('customer',document.getElementById('rCustomer').value.trim());
  fd.append('amount',document.getElementById('rAmount').value.trim());
  fd.append('course',document.getElementById('rCourse').value.trim());
  fd.append('installment',document.getElementById('rInstallment').value);
  fd.append('notes',document.getElementById('rNotes').value.trim());
  fd.append('receiverName', document.getElementById('rReceiver').value.trim());
  const msg=document.getElementById('rMsg'); msg.textContent= mode==='edit' ? '⏳ جارٍ حفظ التعديل...' : '⏳ جارٍ الحفظ...';
  try{
    const d=await fetch(url,{method:'POST',body:fd}).then(r=>r.json());
    if(d&&d.result==='OK'){
      await buildReceiptOrderCache();
      const bc = String(d.branchCode||'').trim();
      const ord = RECEIPT_ORDER_CACHE.map.get(`${bc}|${d.serial}`) || (RECEIPT_ORDER_CACHE.counts[bc]||0);
      const dispId = displaySerial(bc, ord);

      setText('ridView', dispId || '—'); setText('ridHint', d.branch ? `(${d.branch})` : '');
      msg.textContent= mode==='edit' ? '✅ تم حفظ التعديل' : '✅ تم حفظ الإيصال';

      fillPreview({
        receiptId: dispId,
        date:d.date,customer:d.customer,amount:d.amount,course:d.course,
        installment:d.installment,notes:d.notes,branch:d.branch,receiverName: d.receiverName
      });

      const pv = document.getElementById('receiptPrint');
      pv.style.display='block';
      pv.scrollIntoView({behavior:'smooth',block:'nearest'});

      const lastBranch=document.getElementById('rBranch').value.trim();
      await resetReceiptForm(); 
      document.getElementById('rBranch').value=lastBranch;

      const b=document.getElementById('recBranchFilter').value; const q=document.getElementById('recQ').value.trim();
      await loadReceiptsTable(buildReceiptsEndpoint(b,q));
    } else if (d && d.code==='DUPLICATE_RID'){ msg.textContent='❌ ID مُستخدم بالفعل.'; }
    else { msg.textContent='❌ حدث خطأ في الحفظ'; }
  }catch{ msg.textContent='❌ خطأ في الاتصال'; }
}

function fillPreview(src){
  const obj = src || {
    receiptId: (function(){ return document.getElementById('ridView').textContent.trim(); })(),
    date: (function(){ const v=document.getElementById('rDate').value; return v? v.replace('T',' ') : ''; })(),
    customer: document.getElementById('rCustomer').value.trim(),
    amount: document.getElementById('rAmount').value.trim(),
    course: document.getElementById('rCourse').value.trim(),
    installment: document.getElementById('rInstallment').value,
    notes: document.getElementById('rNotes').value.trim(),
    branch: document.getElementById('rBranch').value.trim(),
    receiverName: document.getElementById('rReceiver').value.trim()
  };
  const pv=document.getElementById('receiptPrint'); 
  pv.style.display='block';
  setText('pvReceiptId', obj.receiptId||""); 
  setText('pvDate', obj.date||""); 
  setText('pvCustomer', obj.customer||"");
  setText('pvAmount', obj.amount||""); 
  setText('pvCourse', obj.course||""); 
  setText('pvInstallment', obj.installment||"");
  setText('pvReceiver', obj.receiverName||"");
  setText('pvNotes', obj.notes||""); 
  setText('pvBranch', obj.branch||"");
}

/* ========= طباعة (مع حفظ تلقائي وفحص اكتمال البيانات) ========= */
async function printReceipt(){
  if(!validateReceiptForm()) return;        // ✅ منع الطباعة قبل الاكتمال
  try{
    await saveReceiptIfNeeded();            // ✅ يحفظ تلقائيًا لو مش محفوظ
  }catch(e){
    alert('حدث خطأ أثناء الحفظ قبل الطباعة: ' + e.message);
    return;
  }

  if(document.getElementById('receiptPrint').style.display==='none'){ fillPreview(null); }
  const src = document.getElementById('receiptPrint');
  const makeCleanCopy = () => {
    const c = src.cloneNode(true);
    c.querySelectorAll('.no-print,button').forEach(el=>el.remove());
    return c;
  };
  const copy1 = makeCleanCopy();
  const copy2 = makeCleanCopy();

  const iframe = document.createElement('iframe');
  iframe.style.position='fixed';
  iframe.style.right='0'; iframe.style.bottom='0';
  iframe.style.width='0';  iframe.style.height='0';
  iframe.style.border='0';
  document.body.appendChild(iframe);

  const w = iframe.contentWindow;
  const doc = w.document;

  doc.open();
  doc.write(`<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    @page{ size:A4; margin:12mm; }
    html,body{ background:#fff; color:#000; margin:0; font-family:'Cairo',Arial,system-ui; }
    *{ box-sizing:border-box }
    .sheet{ display:flex; flex-direction:column; gap:22px; }
    .receipt-box{
      border:1.5px dashed #000; border-radius:12px; padding:16px; background:#fff;
      page-break-inside:avoid;
    }
    .print-head{ display:flex; align-items:center; gap:12px; }
    .print-head img{ height:60px; width:auto; object-fit:contain; }
    .print-head h3{ margin:0; flex:1; text-align:center; font-weight:700; }
    .kv2{ display:grid; grid-template-columns:160px 1fr 160px 1fr; gap:8px 12px; align-items:center; }
    @media print and (max-width:700px){
      .kv2{ grid-template-columns:140px 1fr; }
    }
    .signs{ display:flex; justify-content:space-between; margin:20px 0 40px 0; }
    .signs > div{ font-weight:700; color:#333; }
    .signs > div:first-child{ min-width:100px; text-align:right; }
    .signs > div:last-child{ flex:1; text-align:center; }
    .muted{ color:#475569; }
  </style>
</head>
<body>
  <div class="sheet" id="sheet"></div>
</body>
</html>`);
  doc.close();

  const wrap = doc.getElementById('sheet');
  const box1 = doc.createElement('div'); box1.className = 'receipt-box'; box1.appendChild(copy1);
  const box2 = doc.createElement('div'); box2.className = 'receipt-box'; box2.appendChild(copy2);
  wrap.appendChild(box1);
  wrap.appendChild(box2);

  const doPrint = () => { try{ w.focus(); }catch(_){} w.print(); setTimeout(()=>iframe.remove(), 800); };
  if (doc.fonts && doc.fonts.ready) { doc.fonts.ready.then(doPrint); } else { setTimeout(doPrint, 400); }
}

async function downloadPDF(){
  if(document.getElementById('receiptPrint').style.display==='none'){ fillPreview(null); }
  const el=document.getElementById('receiptPrint');
  const canvas=await html2canvas(el,{scale:2});
  const img=canvas.toDataURL('image/png');
  const {jsPDF}=window.jspdf; const pdf=new jsPDF('p','pt','a5');
  const w=pdf.internal.pageSize.getWidth(), pad=24, iw=w-pad*2, ih=canvas.height*(iw/canvas.width);
  pdf.addImage(img,'PNG',pad,pad,iw,ih);
  const rid=(document.getElementById('pvReceiptId').textContent||'receipt').replace(/[^\dA-Za-z_-]+/g,'_');
  pdf.save(`${rid}.pdf`);
}

async function editReceipt(r){
  openTab('panel-receipts');

  if (!RECEIPT_ORDER_CACHE || !RECEIPT_ORDER_CACHE.map || RECEIPT_ORDER_CACHE.map.size===0){
    await buildReceiptOrderCache();
  }

  setVal('rBranch', r.branch||"");
  setVal('rCustomer', r.customer||""); setVal('rStudentId','X');
  setVal('rCourse', r.course||""); 
  const courseInput = document.getElementById('rCourse');
  courseInput.readOnly = false;
  courseInput.style.background = '';

  setVal('rAmount', r.amount||""); setVal('rInstallment', r.installment||"1");
  setVal('rNotes', r.notes||"");
  setVal('rReceiver', r.receiverName || "");
  if (r.date){ const t=r.date.replace(' ','T'); setVal('rDate', t.length===16?t:t.substring(0,16)); }

  const dispId = displaySerialForRow(r) || "";
  setText('ridView', dispId || "—"); setText('ridHint', r.branch? `(${r.branch})` : '');

  document.getElementById('rMode').value='edit';
  document.getElementById('rSubmitBtn').textContent='💾 حفظ التعديل';
  document.getElementById('prevReceiptId').value = r.receiptId || "";

  fillPreview({
    receiptId: dispId,
    date:r.date||"",customer:r.customer||"",amount:r.amount||"",course:r.course||"",
    installment:r.installment||"",notes:r.notes||"",branch:r.branch||"",
    receiverName: r.receiverName || ""
  });
}
function previewAndPrint(r){ editReceipt(r); printReceipt(); }
</script>
</body>
</html>
